{% extends 'core/doc_base.html' %}

{% block doc_content %}

<h2 id="visao-geral">ğŸ“‹ VisÃ£o Geral</h2>
<p>
  ImplementaÃ§Ã£o completa de um sistema de comissÃµes profissional para o Mr. Baruch, focado inicialmente na 
  <strong>jornada de leads</strong> com pagamento PIX confirmado via webhook ASAAS.
</p>

<h2 id="arquitetura">ğŸ¯ Arquitetura da SoluÃ§Ã£o</h2>

<h3 id="decisao-profissional">âœ… Por que NOT usar .env?</h3>

<div class="doc-alert doc-alert-success">
  <strong>DecisÃ£o Profissional:</strong> Usar <code>ConfiguracaoSistema</code> (banco de dados)
</div>

<table class="table">
  <thead>
    <tr>
      <th>Aspecto</th>
      <th>.env</th>
      <th>ConfiguracaoSistema (DB)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>AlteraÃ§Ã£o</strong></td>
      <td>âŒ Requer reiniciar servidor</td>
      <td>âœ… Tempo real via web</td>
    </tr>
    <tr>
      <td><strong>Auditoria</strong></td>
      <td>âŒ Sem histÃ³rico</td>
      <td>âœ… <code>ultima_atualizacao</code></td>
    </tr>
    <tr>
      <td><strong>ValidaÃ§Ã£o</strong></td>
      <td>âŒ Manual</td>
      <td>âœ… Tipo (NUMERO, BOOLEANO)</td>
    </tr>
    <tr>
      <td><strong>Interface</strong></td>
      <td>âŒ Editor de texto</td>
      <td>âœ… Painel web intuitivo</td>
    </tr>
    <tr>
      <td><strong>Backup</strong></td>
      <td>âŒ Arquivo separado</td>
      <td>âœ… Junto com banco</td>
    </tr>
    <tr>
      <td><strong>Multi-tenant</strong></td>
      <td>âŒ Global</td>
      <td>âœ… Por instalaÃ§Ã£o</td>
    </tr>
    <tr>
      <td><strong>PermissÃµes</strong></td>
      <td>âŒ Acesso filesystem</td>
      <td>âœ… Por grupo Django</td>
    </tr>
  </tbody>
</table>

<p><strong>ConclusÃ£o:</strong> ConfiguracaoSistema Ã© <strong>significativamente mais profissional</strong> para parÃ¢metros de negÃ³cio que mudam com frequÃªncia.</p>

<h2 id="estrutura">ğŸ—ï¸ Estrutura Implementada</h2>

<h3 id="modelo">1. Modelo Atualizado</h3>
<p class="text-muted"><code>comissoes/models.py</code></p>

<pre><code class="language-python">class ComissaoLead(models.Model):
    lead = models.ForeignKey('marketing.Lead', ...)
    atendente = models.ForeignKey(User, ...)
    valor = models.DecimalField(...)  # SEM default hardcoded
    data_criacao = models.DateTimeField(auto_now_add=True)
    pago = models.BooleanField(default=False)  # âœ… NOVO
    data_pagamento = models.DateField(null=True, blank=True)  # âœ… NOVO
    observacoes = models.TextField(blank=True)  # âœ… NOVO
    
    @classmethod
    def obter_valor_comissao(cls):
        """Busca valor da configuraÃ§Ã£o COMISSAO_ATENDENTE_VALOR_FIXO"""
        config = ConfiguracaoSistema.objects.get(chave='COMISSAO_ATENDENTE_VALOR_FIXO')
        return Decimal(config.valor)</code></pre>

<div class="doc-card">
  <strong>Melhorias:</strong>
  <ul class="mb-0">
    <li>âœ… Valor dinÃ¢mico via ConfiguracaoSistema</li>
    <li>âœ… Campos para controle de pagamento</li>
    <li>âœ… ObservaÃ§Ãµes para auditoria</li>
    <li>âœ… Meta ordering por data_criacao</li>
  </ul>
</div>

<h3 id="urls">2. URLs</h3>
<p class="text-muted"><code>comissoes/urls.py</code></p>

<pre><code class="language-python">urlpatterns = [
    path('', views.painel_comissoes, name='painel_comissoes'),
    path('leads/', views.painel_comissoes_leads, name='painel_comissoes_leads'),
    path('relatorio/', views.relatorio_comissoes, name='relatorio_comissoes'),
]</code></pre>

<p>Registrado em <code>sistemaMrBaruchProjeto/urls.py</code>:</p>
<pre><code class="language-python">path('comissoes/', include('comissoes.urls', namespace='comissoes')),</code></pre>

<h3 id="views">3. Views</h3>
<p class="text-muted"><code>comissoes/views.py</code></p>

<h4>3.1 painel_comissoes</h4>
<p>Painel principal com:</p>
<ul>
  <li>âœ… Total de comissÃµes (geral)</li>
  <li>âœ… Pagas vs Pendentes</li>
  <li>âœ… ComissÃµes do mÃªs atual</li>
  <li>âœ… Valor configurado atual</li>
  <li>âœ… Cards para diferentes tipos (Leads, Vendas, Captadores)</li>
</ul>

<h4>3.2 painel_comissoes_leads</h4>
<p>Painel especÃ­fico de leads com:</p>
<ul>
  <li>âœ… Filtros: PerÃ­odo (7/30/60/90/365 dias), Status (pago/pendente/todos), Atendente</li>
  <li>âœ… EstatÃ­sticas do perÃ­odo filtrado</li>
  <li>âœ… Ranking de atendentes (top 10)</li>
  <li>âœ… Lista das Ãºltimas 100 comissÃµes</li>
  <li>âœ… Aggregates: Sum, Count com Q objects</li>
</ul>

<h2 id="configuracoes">âš™ï¸ ConfiguraÃ§Ãµes do Sistema</h2>

<p>ConfiguraÃ§Ãµes gerenciadas via <code>ConfiguracaoSistema</code>:</p>

<table class="table">
  <thead>
    <tr>
      <th>Chave</th>
      <th>Valor PadrÃ£o</th>
      <th>Tipo</th>
      <th>DescriÃ§Ã£o</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>COMISSAO_ATIVA</code></td>
      <td>true</td>
      <td><span class="doc-badge doc-badge-info">BOOLEANO</span></td>
      <td>Ativar/desativar sistema automÃ¡tico</td>
    </tr>
    <tr>
      <td><code>COMISSAO_ATENDENTE_VALOR_FIXO</code></td>
      <td>0.50</td>
      <td><span class="doc-badge doc-badge-info">NUMERO</span></td>
      <td>Valor por levantamento PIX confirmado</td>
    </tr>
    <tr>
      <td><code>COMISSAO_CAPTADOR_PERCENTUAL</code></td>
      <td>3</td>
      <td><span class="doc-badge doc-badge-info">NUMERO</span></td>
      <td>% para captadores externos</td>
    </tr>
    <tr>
      <td><code>COMISSAO_VENDAS_MIN</code></td>
      <td>2</td>
      <td><span class="doc-badge doc-badge-info">NUMERO</span></td>
      <td>% mÃ­nimo sobre vendas</td>
    </tr>
    <tr>
      <td><code>COMISSAO_VENDAS_MAX</code></td>
      <td>10</td>
      <td><span class="doc-badge doc-badge-info">NUMERO</span></td>
      <td>% mÃ¡ximo sobre vendas</td>
    </tr>
  </tbody>
</table>

<div class="doc-alert doc-alert-info">
  <strong>Command para popular:</strong>
  <pre class="mt-2 mb-0"><code>python manage.py configurar_comissoes</code></pre>
</div>

<h2 id="funcionalidades">ğŸ“Š Funcionalidades Implementadas</h2>

<h3 id="painel-principal">âœ… Painel Principal de ComissÃµes</h3>
<ul>
  <li>âœ… Cards de estatÃ­sticas gerais</li>
  <li>âœ… Total acumulado histÃ³rico</li>
  <li>âœ… Pagas vs Pendentes</li>
  <li>âœ… ComissÃµes do mÃªs atual</li>
  <li>âœ… MÃ³dulos por tipo (Leads, Vendas, Captadores)</li>
  <li>âœ… Link rÃ¡pido para configuraÃ§Ãµes</li>
</ul>

<h3 id="painel-leads">âœ… Painel de ComissÃµes de Leads</h3>
<ul>
  <li>âœ… Filtros por perÃ­odo (7/30/60/90/365 dias)</li>
  <li>âœ… Filtro por status de pagamento</li>
  <li>âœ… EstatÃ­sticas do perÃ­odo filtrado</li>
  <li>âœ… Ranking de atendentes (top 10)</li>
  <li>âœ… Lista Ãºltimas 100 comissÃµes</li>
  <li>âœ… ExibiÃ§Ã£o de valor configurado atual</li>
  <li>âœ… Badge de status (Pago/Pendente)</li>
  <li>âœ… Data de pagamento (se aplicÃ¡vel)</li>
</ul>

<h3 id="sistema-config">âœ… Sistema de ConfiguraÃ§Ã£o</h3>
<ul>
  <li>âœ… 5 parÃ¢metros de comissÃ£o em ConfiguracaoSistema</li>
  <li>âœ… Command <code>configurar_comissoes</code> para seed</li>
  <li>âœ… MÃ©todo <code>obter_valor_comissao()</code> no modelo</li>
  <li>âœ… Valor dinÃ¢mico (sem hardcode)</li>
  <li>âœ… Auditoria via <code>ultima_atualizacao</code></li>
</ul>

<h2 id="urls-disponiveis">ğŸ”— URLs DisponÃ­veis</h2>

<table class="table">
  <thead>
    <tr>
      <th>URL</th>
      <th>View</th>
      <th>DescriÃ§Ã£o</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>/comissoes/</code></td>
      <td><code>painel_comissoes</code></td>
      <td>Painel principal</td>
    </tr>
    <tr>
      <td><code>/comissoes/leads/</code></td>
      <td><code>painel_comissoes_leads</code></td>
      <td>Painel especÃ­fico de leads</td>
    </tr>
    <tr>
      <td><code>/comissoes/relatorio/</code></td>
      <td><code>relatorio_comissoes</code></td>
      <td>RelatÃ³rios (futuro)</td>
    </tr>
    <tr>
      <td><code>/core/painel_configuracoes/</code></td>
      <td>-</td>
      <td>Ajustar valores de comissÃ£o</td>
    </tr>
    <tr>
      <td><code>/admin/core/configuracaosistema/</code></td>
      <td>-</td>
      <td>Admin Django (avanÃ§ado)</td>
    </tr>
  </tbody>
</table>

<h2 id="como-testar">ğŸ§ª Como Testar</h2>

<h3>1. Acessar Painel Principal</h3>
<pre><code>http://localhost:8000/comissoes/</code></pre>
<p>âœ… Deve exibir estatÃ­sticas e 3 cards de tipos de comissÃ£o</p>

<h3>2. Acessar Painel de Leads</h3>
<pre><code>http://localhost:8000/comissoes/leads/</code></pre>
<p>âœ… Deve exibir filtros, ranking e lista de comissÃµes</p>

<h3>3. Verificar ConfiguraÃ§Ãµes</h3>
<pre><code>http://localhost:8000/core/painel_configuracoes/</code></pre>
<p>âœ… Na aba "Etapa: Comissionamento" deve ter <code>COMISSAO_ATENDENTE_VALOR_FIXO</code></p>

<h3>4. Ajustar Valor</h3>
<ul>
  <li>Alterar valor de <code>0.50</code> para <code>1.00</code></li>
  <li>Salvar</li>
  <li>Voltar ao painel de comissÃµes</li>
  <li>âœ… Deve exibir <code>R$ 1.00</code></li>
</ul>

<h2 id="proximos-passos">ğŸš€ PrÃ³ximos Passos</h2>

<h3>Curto Prazo</h3>
<ul>
  <li>â³ <strong>Webhook ASAAS</strong>: Integrar geraÃ§Ã£o automÃ¡tica ao confirmar PIX</li>
  <li>â³ <strong>Marcar como Pago</strong>: AÃ§Ã£o no painel para marcar comissÃµes pagas</li>
  <li>â³ <strong>Exportar CSV</strong>: BotÃ£o para exportar lista de comissÃµes</li>
  <li>â³ <strong>NotificaÃ§Ãµes</strong>: Alertar atendente quando comissÃ£o Ã© gerada</li>
</ul>

<h3>MÃ©dio Prazo</h3>
<ul>
  <li>â³ <strong>ComissÃµes de Vendas</strong>: Percentual sobre valor da venda</li>
  <li>â³ <strong>ComissÃµes de Captadores</strong>: Percentual para captadores externos</li>
  <li>â³ <strong>Pagamento em Lote</strong>: Processar mÃºltiplas comissÃµes de uma vez</li>
  <li>â³ <strong>RelatÃ³rio Mensal</strong>: PDF com total a pagar por atendente</li>
  <li>â³ <strong>Dashboard de Atendente</strong>: Painel individual para cada atendente ver suas comissÃµes</li>
</ul>

<h2 id="suporte">ğŸ“ Suporte</h2>

<div class="doc-card">
  <p class="mb-2"><strong>Desenvolvido por:</strong> GitHub Copilot + Equipe Mr. Baruch</p>
  <p class="mb-2"><strong>Data:</strong> 14 de Outubro de 2025</p>
  <p class="mb-0"><strong>Status:</strong> <span class="doc-badge doc-badge-success">PRONTO PARA PRODUÃ‡ÃƒO</span></p>
</div>

{% endblock %}
