{% extends 'base/base.html' %}
{% load static %}
{% block title %}Transferências de Comissões{% endblock %}
{% block content %}
<div class="container-fluid px-4 py-4">
  <!-- Header -->
  <div class="row align-items-center mb-4">
    <div class="col-md-8">
      <h2 class="fw-bold text-dark mb-1">
        <i class="bi bi-bank text-primary me-2"></i>Transferências de Comissões
      </h2>
      <p class="text-muted mb-0">Consolidação mensal de valores pagos e administração das transferências bancárias</p>
    </div>
    <div class="col-md-4 text-md-end mt-3 mt-md-0">
      <a href="{% url 'comissoes:painel_gestao' %}" class="btn btn-outline-secondary rounded-pill">
        <i class="bi bi-arrow-left-circle me-1"></i> Voltar à Gestão
      </a>
    </div>
  </div>

  <!-- Cards de Resumo -->
  <div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted text-uppercase small mb-1">Total a Transferir</h6>
              <h3 class="fw-bold text-primary mb-0">R$ {{ total_transferencias|floatformat:2|default:"0,00" }}</h3>
              <small class="text-muted">{{ quantidade_registros }} registro{{ quantidade_registros|pluralize }}</small>
            </div>
            <i class="bi bi-cash-stack fs-1 text-primary opacity-25"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted text-uppercase small mb-1">Atendentes</h6>
              <h3 class="fw-bold text-info mb-0">{{ total_atendentes }}</h3>
              <small class="text-muted">funcionários</small>
            </div>
            <i class="bi bi-headset fs-1 text-info opacity-25"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted text-uppercase small mb-1">Consultores</h6>
              <h3 class="fw-bold text-success mb-0">{{ total_consultores }}</h3>
              <small class="text-muted">funcionários</small>
            </div>
            <i class="bi bi-cart-check-fill fs-1 text-success opacity-25"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted text-uppercase small mb-1">Captadores</h6>
              <h3 class="fw-bold text-warning mb-0">{{ total_captadores }}</h3>
              <small class="text-muted">funcionários</small>
            </div>
            <i class="bi bi-people-fill fs-1 text-warning opacity-25"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <form method="GET" action="">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label fw-semibold">Cargo</label>
            <select name="tipo" class="form-select" onchange="this.form.submit()">
              <option value="todos" {% if tipo_filtro == 'todos' %}selected{% endif %}>Todos</option>
              <option value="atendente" {% if tipo_filtro == 'atendente' %}selected{% endif %}>Atendentes</option>
              <option value="consultor" {% if tipo_filtro == 'consultor' %}selected{% endif %}>Consultores</option>
              <option value="captador" {% if tipo_filtro == 'captador' %}selected{% endif %}>Captadores</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">Mês/Ano</label>
            <input type="month" name="mes" class="form-control" value="{{ mes_filtro }}" onchange="this.form.submit()">
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Buscar Funcionário</label>
            <input type="text" name="busca" class="form-control" placeholder="Nome, e-mail..." value="{{ busca }}" onkeyup="if(event.key=='Enter')this.form.submit()">
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold">&nbsp;</label>
            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-search me-1"></i>Filtrar
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabela de Transferências -->
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-light border-0">
      <h5 class="mb-0">
        <i class="bi bi-list-ul me-2"></i>Transferências Pendentes
      </h5>
    </div>
    <div class="card-body p-0">
      {% if transferencias %}
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Mês</th>
              <th>Funcionário</th>
              <th>Cargo</th>
              <th>Contato</th>
              <th>Chave PIX</th>
              <th>Conta Bancária</th>
              <th>Total Pago</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for registro in transferencias %}
            <tr>
              <td><strong>{{ registro.mes }}</strong></td>
              <td>
                <div>
                  <strong>{{ registro.usuario.get_full_name|default:registro.usuario.username }}</strong>
                  <br><small class="text-muted">{{ registro.usuario.email }}</small>
                </div>
              </td>
              <td>
                {% if registro.tipo == 'atendente' %}
                  <span class="badge bg-info">Atendente</span>
                {% elif registro.tipo == 'consultor' %}
                  <span class="badge bg-success">Consultor</span>
                {% elif registro.tipo == 'captador' %}
                  <span class="badge bg-warning text-dark">Captador</span>
                {% endif %}
              </td>
              <td>
                {% if registro.dados_usuario.telefone %}
                  <i class="bi bi-telephone text-primary me-1"></i>{{ registro.dados_usuario.telefone }}
                {% else %}
                  <small class="text-muted">-</small>
                {% endif %}
              </td>
              <td>
                {% if registro.dados_usuario.chave_pix %}
                  <div class="d-flex align-items-center gap-2">
                    <code class="small">{{ registro.dados_usuario.chave_pix|truncatechars:30 }}</code>
                    <button class="btn btn-sm btn-outline-primary" onclick="copiarTexto('{{ registro.dados_usuario.chave_pix }}', this)" title="Copiar PIX">
                      <i class="bi bi-clipboard"></i>
                    </button>
                  </div>
                {% else %}
                  <span class="badge bg-warning text-dark">
                    <i class="bi bi-exclamation-triangle me-1"></i>Não cadastrado
                  </span>
                {% endif %}
              </td>
              <td>
                {% if registro.dados_usuario.conta_bancaria %}
                  <div class="small">
                    {% if registro.dados_usuario.conta_bancaria.banco %}
                      <strong>{{ registro.dados_usuario.conta_bancaria.banco }}</strong><br>
                    {% endif %}
                    {% if registro.dados_usuario.conta_bancaria.agencia %}
                      Ag: {{ registro.dados_usuario.conta_bancaria.agencia }}
                    {% endif %}
                    {% if registro.dados_usuario.conta_bancaria.conta %}
                      / Cc: {{ registro.dados_usuario.conta_bancaria.conta }}
                    {% endif %}
                  </div>
                {% else %}
                  <span class="badge bg-warning text-dark">
                    <i class="bi bi-exclamation-triangle me-1"></i>Não cadastrado
                  </span>
                {% endif %}
              </td>
              <td>
                <strong class="text-success">R$ {{ registro.total_pago|floatformat:2 }}</strong>
              </td>
              <td>
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-sm btn-info" data-bs-toggle="collapse" data-bs-target="#detalhes{{ forloop.counter }}" aria-expanded="false">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button type="button" class="btn btn-sm btn-success" onclick="confirmarTransferencia('{{ registro.usuario.id }}', '{{ registro.tipo }}', '{{ registro.mes }}', '{{ registro.total_pago }}')">
                    <i class="bi bi-check-circle"></i>
                  </button>
                  <a href="{% url 'accounts:perfil_atendente' %}" class="btn btn-sm btn-outline-secondary" title="Editar dados bancários">
                    <i class="bi bi-pencil"></i>
                  </a>
                </div>
              </td>
            </tr>
            <!-- Linha de detalhes (collapse) -->
            <tr class="collapse" id="detalhes{{ forloop.counter }}">
              <td colspan="8" class="p-0">
                <div class="bg-light p-4">
                  <h6 class="text-uppercase text-muted small mb-3">
                    <i class="bi bi-info-circle me-2"></i>Detalhes da Transferência
                  </h6>
                  <div class="row g-3">
                    <div class="col-md-3">
                      <div class="p-3 bg-white rounded border">
                        <small class="text-muted d-block mb-1">Cargo</small>
                        <strong class="d-block">{{ registro.tipo|title }}</strong>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="p-3 bg-white rounded border">
                        <small class="text-muted d-block mb-1">Competência</small>
                        <strong class="d-block">{{ registro.mes }}</strong>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="p-3 bg-white rounded border">
                        <small class="text-muted d-block mb-1">ID do Usuário</small>
                        <strong class="d-block">{{ registro.usuario.id }}</strong>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="p-3 bg-white rounded border">
                        <small class="text-muted d-block mb-1">Status</small>
                        <span class="badge bg-warning">Pendente</span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="alert alert-info mt-3 mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Nota:</strong> Para visualizar comissões detalhadas, acesse o relatório específico do usuário.
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-center py-5">
        <i class="bi bi-inbox fs-1 text-muted mb-3 d-block"></i>
        <p class="text-muted mb-0">Nenhuma transferência encontrada com os filtros aplicados.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
function copiarTexto(texto, btn) {
  navigator.clipboard.writeText(texto).then(() => {
    const iconOriginal = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check"></i>';
    btn.classList.remove('btn-outline-primary');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
      btn.innerHTML = iconOriginal;
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-primary');
    }, 2000);
  }).catch(err => {
    alert('Erro ao copiar: ' + err);
  });
}

function confirmarTransferencia(userId, tipo, mes, valor) {
  var mensagem = 'Confirmar transferência de R$ ' + valor + ' para ' + tipo + ' referente a ' + mes + '?';
  if (!confirm(mensagem)) {
    return;
  }
  
  // Aqui você implementaria a lógica de confirmação da transferência
  alert('Funcionalidade de confirmação será implementada em breve!');
}
</script>

<style>
/* Tabela */
.table th {
  font-weight: 600;
  font-size: 0.875rem;
  text-transform: uppercase;
  color: #6c757d;
}

.btn-group .btn {
  padding: 0.25rem 0.5rem;
}

code {
  background-color: #f8f9fa;
  padding: 0.25rem 0.5rem;
  border-radius: 0.25rem;
}
</style>
{% endblock %}
