<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orçamento {% if venda %}#{{ venda.id }} - {{ venda.cliente.lead.nome_completo }}{% elif pre_venda %}Pré-venda - {{ pre_venda.lead.nome_completo }}{% endif %}</title>
    <style>
        @page {
            size: A4;
            margin: 15mm 15mm 15mm 15mm;
        }
        
        @media print {
            .no-print { 
                display: none !important; 
            }
            
            body { 
                margin: 0 !important; 
                padding: 0 !important;
                background: white !important;
            }
            
            .container { 
                box-shadow: none !important; 
                padding: 0 !important;
                max-width: 100% !important;
                margin: 0 !important;
            }
            
            /* Forçar cores de fundo na impressão */
            .header,
            .servico-box,
            .valores-box,
            .info-box,
            .observacoes,
            .footer,
            .parcelas-table thead,
            .parcelas-table tbody tr:nth-child(even) {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Garantir que gradientes apareçam */
            .header {  
                background: #6f42c1 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .servico-box {
                background: #667eea !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Evitar quebra de página dentro de elementos */
            .info-box,
            .servico-box,
            .valores-box,
            .observacoes,
            .info-grid {
                page-break-inside: avoid !important;
            }
            
            /* Garantir cores de texto */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            color: #222;
            line-height: 1.4;
            background: #f5f5f5;
            padding: 10px;
            font-size: 11pt;
        }
        
        .container {
            max-width: 210mm;
            margin: 0 auto;
            background: white;
            padding: 0;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #6f42c1 0%, #5a35a0 100%);
            color: white !important;
            padding: 15px 20px;
            text-align: center;
            border-bottom: 4px solid #4a2c7f;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .header h1 {
            font-size: 24pt;
            margin-bottom: 3px;
            font-weight: 700;
            color: white !important;
        }
        
        .header .subtitle {
            font-size: 10pt;
            opacity: 0.95;
            color: white !important;
        }
        
        .content {
            padding: 20px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .info-box {
            border: 2px solid #6f42c1;
            border-radius: 6px;
            padding: 12px;
            background: #f9f7fc;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .info-box h3 {
            color: #6f42c1;
            font-size: 11pt;
            margin-bottom: 8px;
            font-weight: 700;
            border-bottom: 2px solid #6f42c1;
            padding-bottom: 4px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 9pt;
            line-height: 1.3;
        }
        
        .info-label {
            color: #555;
            font-weight: 600;
        }
        
        .info-value {
            color: #222;
            font-weight: 700;
            text-align: right;
        }
        
        .servico-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white !important;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .servico-box h2 {
            font-size: 14pt;
            margin-bottom: 5px;
            color: white !important;
        }
        
        .servico-box p {
            font-size: 9pt;
            line-height: 1.4;
            margin: 3px 0;
            color: white !important;
        }
        
        .valores-box {
            background: #fff9e6;
            border: 2px solid #ffc107;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .valores-box h3 {
            color: #856404;
            font-size: 12pt;
            margin-bottom: 10px;
            text-align: center;
            font-weight: 700;
        }
        
        .valor-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #ffe69c;
            font-size: 10pt;
        }
        
        .valor-item:last-child {
            border-bottom: none;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 2px solid #ffc107;
        }
        
        .valor-item.total {
            font-size: 13pt;
            font-weight: 700;
            color: #856404;
        }
        
        .parcelas-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 9pt;
        }
        
        .parcelas-table thead {
            background: #6f42c1;
            color: white !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .parcelas-table th {
            padding: 8px 6px;
            text-align: left;
            font-weight: 700;
            font-size: 9pt;
            color: white !important;
        }
        
        .parcelas-table td {
            padding: 6px 6px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .parcelas-table tbody tr:nth-child(even) {
            background: #f9f9f9;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .observacoes {
            background: #e7f3ff;
            border-left: 4px solid #0d6efd;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 9pt;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .observacoes:last-child {
            margin-bottom: 0;
        }
        
        .observacoes h4 {
            color: #0d6efd;
            margin-bottom: 6px;
            font-size: 10pt;
        }
        
        .footer {
            text-align: center;
            padding: 15px 20px;
            border-top: 2px solid #6f42c1;
            color: #666;
            font-size: 8pt;
            margin-top: 15px;
            background: #f9f7fc;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .footer p {
            margin: 3px 0;
        }
        
        .btn-imprimir {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 12pt;
            border-radius: 6px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
            font-weight: 700;
            box-shadow: 0 4px 8px rgba(111, 66, 193, 0.3);
        }
        
        .btn-imprimir:hover {
            background: #5a35a0;
        }
        
        .btn-voltar {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 25px;
            font-size: 10pt;
            border-radius: 6px;
            cursor: pointer;
            display: inline-block;
            margin: 10px 5px;
            text-decoration: none;
        }
        
        .btn-voltar:hover {
            background: #5a6268;
        }
        
        h3.section-title {
            color: #6f42c1;
            font-size: 11pt;
            margin: 15px 0 10px 0;
            font-weight: 700;
            border-bottom: 2px solid #6f42c1;
            padding-bottom: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ORÇAMENTO</h1>
            <p class="subtitle">
                {% if venda %}Orçamento Nº {{ 4655|add:venda.id }}{% elif pre_venda %}Pré-venda{% endif %} | Emitido em: {{ data_emissao|date:"d/m/Y" }}
            </p>
        </div>
        
        <div class="content">
            <!-- Informações da Empresa e Cliente -->
            <div class="info-grid">
                <div class="info-box">
                    <h3>EMPRESA</h3>
                    <div class="info-row">
                        <span class="info-label">Razão Social:</span>
                        <span class="info-value">{{ empresa.nome }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">CNPJ:</span>
                        <span class="info-value">{{ empresa.cnpj }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Endereço:</span>
                        <span class="info-value">{{ empresa.endereco }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Bairro:</span>
                        <span class="info-value">{{ empresa.bairro }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Cidade/UF:</span>
                        <span class="info-value">{{ empresa.cidade }}/{{ empresa.estado }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">CEP:</span>
                        <span class="info-value">{{ empresa.cep }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">E-mail:</span>
                        <span class="info-value">{{ empresa.email }}</span>
                    </div>
                </div>
                
                <div class="info-box">
                    <h3>CLIENTE</h3>
                    {% if venda %}
                        <div class="info-row">
                            <span class="info-label">Nome:</span>
                            <span class="info-value">{{ venda.cliente.lead.nome_completo }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">CPF/CNPJ:</span>
                            <span class="info-value">{{ venda.cliente.lead.cpf_cnpj|default:"Não informado" }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">E-mail:</span>
                            <span class="info-value">{{ venda.cliente.lead.email|default:"Não informado" }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Telefone:</span>
                            <span class="info-value">{{ venda.cliente.lead.telefone }}</span>
                        </div>
                        {% if venda.cliente.lead.endereco %}
                        <div class="info-row">
                            <span class="info-label">Endereço:</span>
                            <span class="info-value">{{ venda.cliente.lead.endereco }}</span>
                        </div>
                        {% endif %}
                        {% if venda.cliente.rua %}
                        <div class="info-row">
                            <span class="info-label">Endereço:</span>
                            <span class="info-value">{{ venda.cliente.rua }}, {{ venda.cliente.numero }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Bairro:</span>
                            <span class="info-value">{{ venda.cliente.bairro }}</span>
                        </div>
                        {% endif %}
                        {% if venda.cliente.cidade and venda.cliente.estado %}
                        <div class="info-row">
                            <span class="info-label">Cidade/UF:</span>
                            <span class="info-value">{{ venda.cliente.cidade }}/{{ venda.cliente.estado }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">CEP:</span>
                            <span class="info-value">{{ venda.cliente.cep }}</span>
                        </div>
                        {% endif %}
                    {% elif pre_venda %}
                        <div class="info-row">
                            <span class="info-label">Nome:</span>
                            <span class="info-value">{{ pre_venda.lead.nome_completo }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">CPF/CNPJ:</span>
                            <span class="info-value">{{ pre_venda.lead.cpf_cnpj|default:"Não informado" }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">E-mail:</span>
                            <span class="info-value">{{ pre_venda.lead.email|default:"Não informado" }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Telefone:</span>
                            <span class="info-value">{{ pre_venda.lead.telefone }}</span>
                        </div>
                        {% if pre_venda.lead.endereco %}
                        <div class="info-row">
                            <span class="info-label">Endereço:</span>
                            <span class="info-value">{{ pre_venda.lead.endereco }}</span>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            
            <!-- Serviço Contratado -->
            <div class="servico-box">
                <h2>SERVIÇO CONTRATADO</h2>
                {% if venda %}
                    <p><strong>{{ venda.servico.nome }}</strong></p>
                    {% if venda.servico.descricao %}
                    <p>{{ venda.servico.descricao }}</p>
                    {% endif %}
                {% elif pre_venda %}
                    <p><strong>{{ pre_venda.get_servico_interesse_display }}</strong></p>
                {% endif %}
            </div>
            
            <!-- Valores Principais -->
            <div class="valores-box">
                                
                <h3>RESUMO FINANCEIRO</h3>
                
                {% if venda %}
                    {% if not venda.sem_entrada %}
                    <div class="valor-item">
                        <span>Entrada ({{ venda.get_forma_entrada_display }}):</span>
                        <span class="valor-moeda"><strong>{{ venda.valor_entrada }}</strong></span>
                    </div>
                    {% else %}
                    <div class="valor-item">
                        <span>Entrada:</span>
                        <span><strong>SEM ENTRADA</strong></span>
                    </div>
                    {% endif %}
                    <div class="valor-item">
                        <span>Parcelamento:</span>
                        <span><strong>{{ venda.quantidade_parcelas }}x de <span class="valor-moeda">{{ venda.valor_parcela }}</span> ({{ venda.get_frequencia_pagamento_display }})</strong></span>
                    </div>
                    <div class="valor-item">
                        <span>Forma de Pagamento:</span>
                        <span><strong>{{ venda.get_forma_pagamento_display }}</strong></span>
                    </div>
                    <div class="valor-item total">
                        <span>VALOR TOTAL:</span>
                        <span class="valor-moeda">{{ venda.valor_total }}</span>
                    </div>
                {% elif pre_venda %}
                    <div class="valor-item">
                        <span>Entrada:</span>
                        <span class="valor-moeda"><strong>{{ pre_venda.valor_entrada|default:'0,00' }}</strong></span>
                    </div>
                    <div class="valor-item">
                        <span>Parcelamento:</span>
                        <span><strong>{{ pre_venda.quantidade_parcelas|default:'1' }}x de <span class="valor-moeda">{{ pre_venda.valor_parcela|default:'0,00' }}</span> ({{ pre_venda.get_frequencia_pagamento_display|default:'Mensal' }})</strong></span>
                    </div>
                    <div class="valor-item">
                        <span>Forma de Pagamento:</span>
                        <span><strong>Boleto</strong></span>
                    </div>
                    <div class="valor-item total">
                        <span>VALOR TOTAL:</span>
                        <span class="valor-moeda">{{ pre_venda.valor_total|default:pre_venda.valor_proposto }}</span>
                    </div>
                {% endif %}
                {% if parcelas %}
                <div style="margin-top:10px;">
                    <strong>Detalhamento das Parcelas:</strong>
                    <ul style="margin: 6px 0 0 0; padding-left: 18px; font-size: 10pt;">
                        {% for parcela in parcelas %}
                        <li>
                            Parcela {{ parcela.numero_parcela }}: R$ {{ parcela.valor|floatformat:2 }} - Vencimento: {{ parcela.data_vencimento|date:"d/m/Y" }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            
            <!-- Cronograma de Parcelas -->
            <!-- CRONOGRAMA DE PAGAMENTO COMENTADO - Valores já aparecem no Resumo Financeiro acima
            {% if parcelas %}
            <h3 class="section-title">CRONOGRAMA DE PAGAMENTO</h3>
            <table class="parcelas-table">
                <thead>
                    <tr>
                        <th>Parcela</th>
                        <th>Vencimento</th>
                        <th>Valor</th>
                        {% if venda %}<th>Status</th>{% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for parcela in parcelas %}
                    <tr>
                        <td>{{ parcela.numero_parcela }}{% if venda %}/{{ venda.quantidade_parcelas }}{% elif pre_venda %}/{{ pre_venda.quantidade_parcelas }}{% endif %}</td>
                        <td>{{ parcela.data_vencimento|date:"d/m/Y" }}</td>
                        <td class="valor-moeda">{{ parcela.valor }}</td>
                        {% if venda %}
                        <td>
                            {% if parcela.status == 'paga' %}
                                Paga
                            {% elif parcela.status == 'vencida' %}
                                Vencida
                            {% elif parcela.status == 'cancelada' %}
                                Cancelada
                            {% else %}
                                Aberta
                            {% endif %}
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
            -->
            
            <!-- Informações Adicionais e Consultor lado a lado -->
            {% if pre_venda or venda.dias_para_conclusao %}
            <h3 class="section-title">INFORMAÇÕES COMPLEMENTARES</h3>
            <div class="info-grid">
                <!-- Coluna Esquerda: Informações Adicionais -->
                <div>
                    {% if pre_venda and pre_venda.observacoes_levantamento %}
                    <div class="observacoes">
                        <p><strong>Observações:</strong> {{ pre_venda.observacoes_levantamento }}</p>
                    </div>
                    {% endif %}
                    {% if venda and venda.dias_para_conclusao %}
                    <div class="observacoes">
                        <h4>Prazo de Execução</h4>
                        <p><strong>Prazo para conclusão:</strong> {{ venda.dias_para_conclusao }} dias corridos</p>
                        {% if venda.data_inicio_servico %}
                        <p><strong>Data prevista de início:</strong> {{ venda.data_inicio_servico|date:"d/m/Y" }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                <!-- Coluna Direita: Consultor -->
                {% if venda %}
                <div class="info-box">
                    <h3>CONSULTOR RESPONSÁVEL</h3>
                    <div class="info-row">
                        <span class="info-label">Nome:</span>
                        <span class="info-value">{{ venda.consultor.get_full_name|default:venda.consultor.username }}</span>
                    </div>
                </div>
                {% endif %}
            </div>
            {% else %}
            <!-- Caso não tenha informações adicionais, mostrar apenas o consultor -->
            {% if venda %}
            <h3 class="section-title">CONSULTOR RESPONSÁVEL</h3>
            <div class="info-box">
                <h3>Responsável pela Venda</h3>
                <div class="info-row">
                    <span class="info-label">Nome:</span>
                    <span class="info-value">{{ venda.consultor.get_full_name|default:venda.consultor.username }}</span>
                </div>
            </div>
            {% endif %}
            {% endif %}
            
            <!-- Botões de Ação -->
            <div class="no-print" style="text-align: center; margin-top: 20px;">
                <button onclick="window.print()" class="btn-imprimir">
                    Imprimir / Salvar PDF
                </button>
                {% if venda %}
                <a href="{% url 'vendas:confirmacao_venda' venda.id %}" class="btn-voltar">
                    ← Voltar
                </a>
                {% elif pre_venda %}
                <a href="{% url 'vendas:registrar_aceite' pre_venda.id %}" class="btn-voltar">
                    ← Voltar
                </a>
                {% endif %}
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p><strong>Este orçamento tem validade de 30 dias a partir da data de emissão.</strong></p>
            <p>{{ empresa.nome }} - CNPJ: {{ empresa.cnpj }}</p>
            <p>{{ empresa.endereco }}, {{ empresa.bairro }} - {{ empresa.cidade }}/{{ empresa.estado }} - CEP: {{ empresa.cep }}</p>
            <p>E-mail: {{ empresa.email }} | © {{ data_emissao|date:"Y" }} - Todos os direitos reservados</p>
        </div>
    </div>
    
    <script>
    // Formatar valores monetários na página para pt-BR (R$ 1.234,56)
    document.addEventListener('DOMContentLoaded', function() {
        function formatarMoeda(valor) {
            if (typeof valor === 'number') {
                return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }
            // Remove tudo que não for número, ponto ou vírgula
            valor = valor.replace(/[^\d,\.]/g, '');
            // Troca vírgula por ponto se for separador decimal
            if (valor.indexOf(',') > -1 && valor.indexOf('.') > -1) {
                if (valor.lastIndexOf(',') > valor.lastIndexOf('.')) {
                    valor = valor.replace(/\./g, '').replace(',', '.');
                } else {
                    valor = valor.replace(/,/g, '');
                }
            } else if (valor.indexOf(',') > -1) {
                valor = valor.replace(',', '.');
            }
            var num = parseFloat(valor);
            if (isNaN(num)) return '';
            return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // Seleciona todos os elementos com a classe 'valor-moeda'
        document.querySelectorAll('.valor-moeda').forEach(function(el) {
            var texto = el.textContent || el.innerText;
            var formatado = formatarMoeda(texto);
            if (formatado) el.textContent = formatado;
        });
    });
    </script>
</body>
</html>
