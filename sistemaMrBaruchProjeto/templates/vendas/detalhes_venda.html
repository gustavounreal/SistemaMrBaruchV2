{% extends 'base/base.html' %}
{% load static %}

{% block title %}Detalhes da Venda #{{ venda.id }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-file-invoice"></i> 
                        Detalhes da Venda #{{ venda.id }}
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Informações do Cliente -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fas fa-user"></i> Cliente</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Nome:</strong> {{ venda.cliente.lead.nome_completo }}</p>
                                    <p><strong>CPF:</strong> {{ venda.cliente.lead.cpf_cnpj }}</p>
                                    <p><strong>Email:</strong> {{ venda.cliente.lead.email }}</p>
                                    <p><strong>Telefone:</strong> {{ venda.cliente.lead.telefone }}</p>
                                    {% if venda.cliente.data_nascimento %}
                                    <p><strong>Data de Nascimento:</strong> {{ venda.cliente.data_nascimento|date:"d/m/Y" }}</p>
                                    {% endif %}
                                    {% if venda.cliente.rua %}
                                    <p class="mb-0"><strong>Endereço:</strong> {{ venda.cliente.rua }}, {{ venda.cliente.numero }} - {{ venda.cliente.bairro }}, {{ venda.cliente.cidade }}/{{ venda.cliente.estado }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Informações da Venda -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fas fa-shopping-cart"></i> Venda</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Data:</strong> {{ venda.data_venda|date:"d/m/Y" }}</p>
                                    <p><strong>Serviço:</strong> {{ venda.servico.nome }}</p>
                                    <p><strong>Valor Total:</strong> R$ <span class="format-brl">{{ venda.valor_total|floatformat:2 }}</span></p>
                                    <p><strong>Parcelas:</strong> {{ venda.quantidade_parcelas }}x de R$ {{ venda.valor_parcela|floatformat:2 }}</p>
                                    <p><strong>Forma Pagamento Parcelas:</strong> {{ venda.get_forma_pagamento_display }}</p>
                                    <p><strong>Status:</strong> 
                                        {% if venda.status == 'CONTRATO_ASSINADO' %}
                                            <span class="badge badge-success">{{ venda.get_status_display }}</span>
                                        {% elif venda.status == 'ORCAMENTO' %}
                                            <span class="badge badge-warning">{{ venda.get_status_display }}</span>
                                        {% elif venda.status == 'CANCELADO' %}
                                            <span class="badge badge-danger">{{ venda.get_status_display }}</span>
                                        {% else %}
                                            <span class="badge badge-info">{{ venda.get_status_display }}</span>
                                        {% endif %}
                                    </p>
                                    <p><strong>Captador:</strong> {{ venda.captador.get_full_name }}</p>
                                    <p class="mb-0"><strong>Consultor:</strong> {{ venda.consultor.get_full_name }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Entradas da Venda -->
                    {% if venda.entradas.exists %}
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> Entradas do Pagamento</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        {% for entrada in venda.entradas.all %}
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100 {% if entrada.status == 'PAGO' %}border-success{% elif entrada.status == 'VENCIDO' %}border-danger{% else %}border-warning{% endif %}">
                                                <div class="card-header {% if entrada.status == 'PAGO' %}bg-success{% elif entrada.status == 'VENCIDO' %}bg-danger{% else %}bg-warning{% endif %} text-white">
                                                    <h6 class="mb-0">
                                                        <i class="fas fa-receipt"></i> Entrada {{ entrada.numero_entrada }}
                                                        {% if entrada.status == 'PAGO' %}
                                                            <span class="badge badge-light text-success float-right">✓ PAGO</span>
                                                        {% elif entrada.status == 'VENCIDO' %}
                                                            <span class="badge badge-light text-danger float-right">⚠ VENCIDO</span>
                                                        {% else %}
                                                            <span class="badge badge-light text-warning float-right">⏳ PENDENTE</span>
                                                        {% endif %}
                                                    </h6>
                                                </div>
                                                <div class="card-body">
                                                    <p><strong>Valor:</strong> R$ {{ entrada.valor|floatformat:2 }}</p>
                                                    <p><strong>Vencimento:</strong> {{ entrada.data_vencimento|date:"d/m/Y" }}</p>
                                                    {% if entrada.data_pagamento %}
                                                    <p><strong>Data Pagamento:</strong> {{ entrada.data_pagamento|date:"d/m/Y H:i" }}</p>
                                                    {% endif %}
                                                    <p><strong>Forma:</strong> {{ entrada.get_forma_pagamento_display }}</p>
                                                    
                                                    {% if entrada.forma_pagamento == 'PIX' and entrada.pix_code %}
                                                    <hr>
                                                    <div class="text-center">
                                                        {% if entrada.pix_qr_code_url %}
                                                        <img src="{{ entrada.pix_qr_code_url }}" alt="QR Code PIX" class="img-fluid mb-2" style="max-width: 200px;">
                                                        {% endif %}
                                                        <div class="input-group mb-2">
                                                            <input type="text" class="form-control form-control-sm" value="{{ entrada.pix_code }}" id="pixCode{{ entrada.id }}" readonly>
                                                            <div class="input-group-append">
                                                                <button class="btn btn-sm btn-outline-primary" type="button" onclick="copiarPix('pixCode{{ entrada.id }}')">
                                                                    <i class="fas fa-copy"></i> Copiar
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% elif entrada.forma_pagamento == 'BOLETO' and entrada.url_boleto %}
                                                    <hr>
                                                    <div class="text-center">
                                                        <a href="{{ entrada.url_boleto }}" target="_blank" class="btn btn-sm btn-primary">
                                                            <i class="fas fa-barcode"></i> Ver Boleto
                                                        </a>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    
                                    <div class="alert alert-info mt-3 mb-0">
                                        <strong>Total das Entradas:</strong> R$ {{ venda.valor_entrada|floatformat:2 }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Configuração de Nota Fiscal - COMENTADO TEMPORARIAMENTE -->
                    <!--
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-file-invoice"></i> Nota Fiscal</h5>
                                </div>
                                <div class="card-body">
                                    {% if venda.cliente_quer_nf %}
                                        <div class="alert alert-success">
                                            <i class="fas fa-check-circle"></i> <strong>Cliente solicitou emissão de Nota Fiscal</strong>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-4">
                                                <p><strong>Tipo de Pessoa:</strong> 
                                                    <span class="badge bg-info">{{ venda.get_nf_tipo_pessoa_display }}</span>
                                                </p>
                                            </div>
                                            <div class="col-md-8">
                                                <p><strong>E-mail para NF:</strong> {{ venda.nf_email|default:venda.cliente.lead.email }}</p>
                                            </div>
                                        </div>

                                        {% if venda.nf_tipo_pessoa == 'PJ' and not venda.cliente.razao_social %}
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <strong>Atenção:</strong> Cliente marcado como Pessoa Jurídica mas não possui Razão Social cadastrada.
                                            <a href="{% url 'admin:clientes_cliente_change' venda.cliente.id %}" class="alert-link" target="_blank">Completar cadastro</a>
                                        </div>
                                        {% endif %}

                                        {% if not venda.cliente.rua or not venda.cliente.cidade or not venda.cliente.estado %}
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <strong>Atenção:</strong> Endereço incompleto. É necessário endereço completo para emissão de NF.
                                            <a href="{% url 'admin:clientes_cliente_change' venda.cliente.id %}" class="alert-link" target="_blank">Completar cadastro</a>
                                        </div>
                                        {% endif %}

                                        <div class="mt-3">
                                            <a href="{% url 'notas_fiscais:dashboard' %}" class="btn btn-success" target="_blank">
                                                <i class="fas fa-file-invoice"></i> Gerenciar Notas Fiscais
                                            </a>
                                        </div>
                                    {% else %}
                                        <p class="text-muted mb-3">
                                            <i class="fas fa-info-circle"></i> 
                                            Cliente não solicitou emissão de Nota Fiscal para esta venda.
                                        </p>
                                        
                                        <button type="button" class="btn btn-outline-success" data-bs-toggle="collapse" data-bs-target="#formAtivarNF">
                                            <i class="fas fa-plus-circle"></i> Ativar Emissão de NF
                                        </button>
                                        
                                        <div class="collapse mt-3" id="formAtivarNF">
                                            <div class="card border-success">
                                                <div class="card-header bg-success text-white">
                                                    <h6 class="mb-0"><i class="fas fa-file-invoice"></i> Configurar Emissão de Nota Fiscal</h6>
                                                </div>
                                                <div class="card-body">
                                                    <form method="post" action="{% url 'vendas:ativar_nota_fiscal' venda.id %}">
                                                        {% csrf_token %}
                                                        
                                                        <div class="alert alert-info">
                                                            <i class="fas fa-info-circle"></i>
                                                            <small>Ao ativar, as notas fiscais serão geradas automaticamente conforme os pagamentos forem confirmados.</small>
                                                        </div>

                                                        <div class="mb-3">
                                                            <label class="form-label">Tipo de Pessoa *</label>
                                                            <select name="nf_tipo_pessoa" class="form-select" required>
                                                                <option value="">Selecione...</option>
                                                                <option value="PF">Pessoa Física</option>
                                                                <option value="PJ">Pessoa Jurídica</option>
                                                            </select>
                                                        </div>

                                                        <div class="mb-3">
                                                            <label class="form-label">E-mail para Recebimento da NF</label>
                                                            <input type="email" name="nf_email" class="form-control" 
                                                                   value="{{ venda.cliente.lead.email }}"
                                                                   placeholder="email@exemplo.com">
                                                            <small class="text-muted">Deixe em branco para usar o e-mail cadastrado do cliente</small>
                                                        </div>

                                                        <div class="alert alert-warning mb-3">
                                                            <strong><i class="fas fa-exclamation-triangle"></i> Requisitos para emissão:</strong>
                                                            <ul class="mb-0 small">
                                                                <li>CPF ou CNPJ válido</li>
                                                                <li>E-mail válido</li>
                                                                <li>Endereço completo (rua, número, cidade, UF, CEP)</li>
                                                                <li>Razão Social (se Pessoa Jurídica)</li>
                                                            </ul>
                                                        </div>
                                                        
                                                        <div class="d-flex gap-2">
                                                            <button type="submit" class="btn btn-success">
                                                                <i class="fas fa-check"></i> Confirmar Ativação
                                                            </button>
                                                            <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#formAtivarNF">
                                                                <i class="fas fa-times"></i> Cancelar
                                                            </button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    -->
                    <!-- FIM DO COMENTÁRIO: Nota Fiscal -->

                    <!-- Origem do Lead -->
                    {% comment %}
                    Seção desabilitada - campo origem_lead não implementado no modelo Venda
                    {% if venda.origem_lead %}
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Origem do Lead</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Nome Lead:</strong> {{ venda.origem_lead.nome }}</p>
                                            <p><strong>Status Lead:</strong> {{ venda.origem_lead.get_status_display }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Data Contato:</strong> {{ venda.origem_lead.data_contato|date:"d/m/Y" }}</p>
                                            {% if venda.origem_lead.origem %}
                                            <p class="mb-0"><strong>Origem:</strong> {{ venda.origem_lead.origem.nome }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endcomment %}

                    <!-- Documentos -->
                    {% if documentos %}
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fas fa-paperclip"></i> Documentos ({{ documentos.count }})</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Tipo</th>
                                                    <th>Data Upload</th>
                                                    <th>Usuário</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for doc in documentos %}
                                                <tr>
                                                    <td>{{ doc.get_tipo_documento_display }}</td>
                                                    <td>{{ doc.data_upload|date:"d/m/Y H:i" }}</td>
                                                    <td>{{ doc.usuario_upload.usuario.get_full_name }}</td>
                                                    <td>
                                                        <a href="{{ doc.arquivo.url }}" target="_blank" 
                                                           class="btn btn-sm btn-primary" title="Baixar">
                                                            <i class="fas fa-download"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Parcelas -->
                    {% if parcelas %}
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Parcelas ({{ parcelas.count }})</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Nº</th>
                                                    <th>Vencimento</th>
                                                    <th>Valor</th>
                                                    <th>Status</th>
                                                    <th>Pagamento</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for parcela in parcelas %}
                                                <tr>
                                                    <td>{{ parcela.numero_parcela }}</td>
                                                    <td>{{ parcela.data_vencimento|date:"d/m/Y" }}</td>
                                                    <td>R$ <span class="format-brl">{{ parcela.valor|floatformat:2 }}</span></td>
                                                    <td>
                                                        {% if parcela.status == 'PAGO' %}
                                                            <span class="badge badge-success">{{ parcela.get_status_display }}</span>
                                                        {% elif parcela.status == 'PENDENTE' %}
                                                            <span class="badge badge-warning">{{ parcela.get_status_display }}</span>
                                                        {% elif parcela.status == 'ATRASADO' %}
                                                            <span class="badge badge-danger">{{ parcela.get_status_display }}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if parcela.data_pagamento %}
                                                            {{ parcela.data_pagamento|date:"d/m/Y" }}
                                                        {% else %}
                                                            -
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Observações -->
                    {% if venda.observacoes %}
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fas fa-comment"></i> Observações</h5>
                                </div>
                                <div class="card-body">
                                    <p class="mb-0">{{ venda.observacoes|linebreaks }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Botões de Ação -->
                    <div class="row">
                        <div class="col-12">
                            <a href="{% url 'vendas:painel_leads_pagos' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Voltar para painel
                            </a>
                            {% if venda.status == 'ATIVA' %}
                            <button type="button" class="btn btn-warning">
                                <i class="fas fa-edit"></i> Editar Venda
                            </button>
                            <button type="button" class="btn btn-danger">
                                <i class="fas fa-ban"></i> Cancelar Venda
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function copiarPix(elementId) {
    const pixInput = document.getElementById(elementId);
    pixInput.select();
    pixInput.setSelectionRange(0, 99999); // Para dispositivos móveis
    
    try {
        document.execCommand('copy');
        alert('✓ Código PIX copiado!');
    } catch (err) {
        // Fallback para navegadores mais novos
        navigator.clipboard.writeText(pixInput.value).then(function() {
            alert('✓ Código PIX copiado!');
        }, function(err) {
            alert('Erro ao copiar código PIX');
        });
    }
}
</script>
{% endblock %}
