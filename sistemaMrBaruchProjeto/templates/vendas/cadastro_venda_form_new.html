{% load static %}
{% load l10n %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Venda - {{ pre_venda.lead.nome_completo }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'css/novo_atendimento.css' %}">`
    <style>
        /* === CPF/CNPJ Consulta Buttons === */
        .cpf-cnpj-links {
            display: flex;
            gap: 10px;
            margin-top: 4px;
            flex-wrap: wrap;
        }
        .cpf-cnpj-links a {
            font-size: 0.97rem;
            font-weight: 600;
            border-radius: 8px !important;
            padding: 8px 18px !important;
            box-shadow: 0 2px 8px rgba(59,130,246,0.08);
            transition: background 0.2s, box-shadow 0.2s, transform 0.2s;
            border-width: 2px !important;
            letter-spacing: 0.01em;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .cpf-cnpj-links a.btn-outline-primary {
            background: linear-gradient(90deg, #e3f0ff 0%, #f8fafc 100%);
            color: #2563eb !important;
            border-color: #2563eb !important;
        }
        .cpf-cnpj-links a.btn-outline-primary:hover {
            background: linear-gradient(90deg, #2563eb 0%, #60a5fa 100%);
            color: #fff !important;
            box-shadow: 0 4px 16px rgba(59,130,246,0.15);
            transform: translateY(-2px);
        }
        .cpf-cnpj-links a.btn-outline-secondary {
            background: linear-gradient(90deg, #f3f4f6 0%, #f8fafc 100%);
            color: #374151 !important;
            border-color: #374151 !important;
        }
        .cpf-cnpj-links a.btn-outline-secondary:hover {
            background: linear-gradient(90deg, #374151 0%, #6b7280 100%);
            color: #fff !important;
            box-shadow: 0 4px 16px rgba(55,65,81,0.13);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
            <h5>Processando...</h5>
            <p class="text-muted">Aguarde enquanto salvamos a venda</p>
        </div>
    </div>

    <div class="form-container">
        <div class="form-header text-center">
            <h4 class="mb-1">Cadastro Completo de Venda</h4>
            <small class="opacity-75">{{ pre_venda.lead.nome_completo }}</small>
        </div>

        <div class="form-body">
            <!-- Indicador de etapas -->
            <div class="step-indicator">
                <div class="step active" id="step1">1</div>
                <div class="step-line" id="line1"></div>
                <div class="step" id="step2">2</div>
                <div class="step-line" id="line2"></div>
                <div class="step" id="step3">3</div>
            </div>

            <div id="alertContainer"></div>

            <form id="vendaForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- ETAPA 1: Dados do Cliente -->
                <div class="form-step active" id="step1Content">
                    <h5 class="text-primary text-center mb-4">
                        <i class="bi bi-person-circle me-2"></i>1. Dados do Cliente
                    </h5>
                    
                    <div class="mb-3">
                        <label class="form-label required" for="nome">Nome Completo</label>
                        <input type="text" class="form-control" name="nome" id="nome" 
                               value="{{ dados_iniciais.nome|default:'' }}" required>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label required" for="cpf">CPF</label>
                            <input type="text" class="form-control" name="cpf" id="cpf" 
                                   value="{{ dados_iniciais.cpf_cnpj|default:'' }}"
                                   placeholder="000.000.000-00" required>
                               
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label required" for="telefone">Telefone</label>
                            <input type="text" class="form-control" name="telefone" id="telefone" 
                                   value="{{ dados_iniciais.telefone|default:'' }}" placeholder="(00) 00000-0000" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="email">E-mail</label>
                            <input type="email" class="form-control" name="email" id="email" 
                                   value="{{ dados_iniciais.email|default:'' }}" placeholder="email@exemplo.com">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label required" for="data_nascimento">Data de Nascimento</label>
                            <input type="date" class="form-control" name="data_nascimento" id="data_nascimento" 
                                   value="{% if pre_venda.lead.data_nascimento %}{{ pre_venda.lead.data_nascimento|date:'Y-m-d' }}{% endif %}" required>
                            {% if pre_venda.lead.data_nascimento %}
                            <small class="text-success"><i class="bi bi-check-circle"></i> Carregado do cadastro do lead</small>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Novos campos: Profiss√£o, Nacionalidade e Estado Civil -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label" for="profissao">Profiss√£o</label>
                            <input type="text" class="form-control" name="profissao" id="profissao" 
                                   placeholder="Ex: Advogado, M√©dico, etc">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label" for="nacionalidade">Nacionalidade</label>
                            <input type="text" class="form-control" name="nacionalidade" id="nacionalidade" 
                                   value="Brasileiro(a)" placeholder="Ex: Brasileiro(a)">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label" for="estado_civil">Estado Civil</label>
                            <select class="form-select" name="estado_civil" id="estado_civil">
                                <option value="">Selecione...</option>
                                <option value="solteiro">Solteiro(a)</option>
                                <option value="casado">Casado(a)</option>
                                <option value="divorciado">Divorciado(a)</option>
                                <option value="viuvo">Vi√∫vo(a)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Campo RG -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="rg">RG (Documento de Identidade)</label>
                            <input type="text" class="form-control" name="rg" id="rg" 
                                   placeholder="Ex: 12.345.678-9" maxlength="20">
                        </div>
                    </div>

                    <!-- Endere√ßo com busca por CEP -->
                    <h6 class="text-secondary mt-4 mb-3">
                        <i class="bi bi-geo-alt me-2"></i>Endere√ßo
                    </h6>

                    <div class="mb-3">
                        <label class="form-label required" for="cep">CEP</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="cep" id="cep" 
                                   placeholder="00000-000" required maxlength="9">
                            <button type="button" class="btn btn-outline-primary" onclick="buscarCep()">
                                <i class="bi bi-search"></i> Buscar CEP
                            </button>
                        </div>
                        <small id="cepInfo" class="form-text text-muted d-block mt-1"></small>
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label required" for="rua">Rua/Logradouro</label>
                            <input type="text" class="form-control" name="rua" id="rua" 
                                   placeholder="Nome da rua" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label required" for="numero">N√∫mero</label>
                            <input type="text" class="form-control" name="numero" id="numero" 
                                   placeholder="N¬∫" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label required" for="bairro">Bairro</label>
                            <input type="text" class="form-control" name="bairro" id="bairro" 
                                   placeholder="Nome do bairro" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label required" for="cidade">Cidade</label>
                            <input type="text" class="form-control" name="cidade" id="cidade" 
                                   placeholder="Cidade" required>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label required" for="estado">UF</label>
                            <input type="text" class="form-control" name="estado" id="estado" 
                                   placeholder="UF" required maxlength="2" style="text-transform: uppercase;">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="complemento">Complemento</label>
                        <input type="text" class="form-control" name="complemento" id="complemento" 
                               placeholder="Apartamento, bloco, etc (opcional)">
                    </div>

                    <div class="d-flex justify-content-end mt-4">
                        <button type="button" class="btn btn-success btn-step" onclick="nextStep(2)">
                            Pr√≥xima Etapa <i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>

                <!-- ETAPA 2: Dados da Venda -->
                <div class="form-step" id="step2Content">
                    <h5 class="text-primary text-center mb-4">
                        <i class="bi bi-cart-check me-2"></i>2. Dados da Venda
                    </h5>

                    <!-- Informa√ß√µes da Pr√©-Venda -->
                    <div class="alert alert-info mb-4">
                        <h6><i class="bi bi-info-circle me-2"></i>Informa√ß√µes da Pr√©-Venda</h6>
                        <p class="mb-1"><strong>Servi√ßo:</strong> {{ pre_venda.get_servico_interesse_display }}</p>
                        <p class="mb-1"><strong>Valor Total:</strong> R$ {{ pre_venda.valor_total|default:pre_venda.valor_proposto|floatformat:2 }}</p>
                        {% if pre_venda.quantidade_parcelas and pre_venda.valor_parcela %}
                        <p class="mb-0"><strong>Parcelamento:</strong> {{ pre_venda.quantidade_parcelas }}x de R$ {{ pre_venda.valor_parcela|floatformat:2 }} <span class="text-muted">({{ pre_venda.get_frequencia_pagamento_display|default:"Mensal" }})</span></p>
                        {% endif %}
                    </div>

                    <!-- Bloco de Resumo Financeiro -->
                    <div class="card shadow-sm mb-4 border-primary">
                        <div class="card-header bg-primary text-white py-2 px-3">
                            <i class="bi bi-calculator me-2"></i>Resumo Financeiro da Venda
                        </div>
                        <div class="card-body py-3 px-3">
                            <div class="row g-2">
                                <div class="col-md-4 col-6">
                                    <div class="small text-muted">Valor Total</div>
                                    <div class="fw-bold">R$ <span id="resumoValorTotal">{{ dados_iniciais.valor_total|default:'0,00' }}</span></div>
                                </div>
                                <div class="col-md-4 col-6">
                                    <div class="small text-muted">Valor de Entrada</div>
                                    <div class="fw-bold">R$ <span id="resumoValorEntrada">{{ dados_iniciais.valor_entrada|default:'0,00' }}</span></div>
                                </div>
                                <div class="col-md-4 col-6">
                                    <div class="small text-muted">Qtd. Parcelas</div>
                                    <div class="fw-bold"><span id="resumoQtdParcelas">{{ dados_iniciais.quantidade_parcelas|default:'1' }}</span></div>
                                </div>
                                <div class="col-md-4 col-6">
                                    <div class="small text-muted">Valor da Parcela</div>
                                    <div class="fw-bold">R$ <span id="resumoValorParcela">{{ dados_iniciais.valor_parcela|default:'0,00' }}</span></div>
                                </div>
                                <div class="col-md-4 col-6">
                                    <div class="small text-muted">Frequ√™ncia</div>
                                    <div class="fw-bold"><span id="resumoFrequencia">{{ dados_iniciais.frequencia_pagamento|default:'Mensal' }}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campo Captador -->
                    <div class="mb-3">
                        <label class="form-label required" for="captador">Captador</label>
                        {% if pre_venda.lead.captador %}
                            <input type="text" class="form-control" 
                                   value="{{ pre_venda.lead.captador.get_full_name|default:pre_venda.lead.captador.username }}" readonly>
                            <input type="hidden" name="captador_id" value="{{ pre_venda.lead.captador.id }}">
                        {% else %}
                            <div class="input-group">
                                <input type="number" class="form-control" name="captador_id" id="captador_id" 
                                       placeholder="Informe o ID do captador" required>
                                <button type="button" class="btn btn-outline-primary" onclick="pesquisarCaptador()">
                                    <i class="bi bi-search"></i> Pesquisar
                                </button>
                            </div>
                            <small id="captadorInfo" class="form-text text-muted d-block mt-1"></small>
                        {% endif %}
                    </div>

                    <!-- Consultor fixo (usu√°rio logado) -->
                    <div class="mb-3">
                        <label class="form-label" for="consultor">Consultor (Vendedor)</label>
                        <input type="text" class="form-control" 
                               value="{{ request.user.get_full_name|default:request.user.username }}" readonly>
                        <small class="form-text text-muted">Automaticamente definido como voc√™ (usu√°rio logado)</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label required" for="valor_total">Valor Total</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control valor-input" name="valor_total_display" 
                                       id="valor_total_display" required>
                                <input type="hidden" name="valor_total" id="valor_total">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label required" for="quantidade_parcelas">Qtd. Parcelas</label>
                            <input type="number" class="form-control" name="quantidade_parcelas" 
                                   id="quantidade_parcelas" min="0" value="1" required>
                            <small class="text-muted">Coloque 0 se pagamento apenas com entrada(s)</small>
                        </div>
                    </div>

                    <!-- SE√á√ÉO DE ENTRADAS -->
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i><strong>Entradas:</strong> Voc√™ pode configurar at√© 2 entradas com valores e datas diferentes
                    </div>

                    <div id="entradas-container">
                        <!-- Entrada 1 -->
                        <div class="card mb-3 entrada-item" data-entrada="1">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="bi bi-cash-stack"></i> Entrada 1</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label required" for="valor_entrada_1_display">Valor da Entrada 1</label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="text" class="form-control valor-input valor-entrada" 
                                                   name="valor_entrada_1_display" id="valor_entrada_1_display" required>
                                            <input type="hidden" name="valor_entrada_1" id="valor_entrada_1" value="0">
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label required" for="data_vencimento_entrada_1">Data de Vencimento</label>
                                        <input type="date" class="form-control" name="data_vencimento_entrada_1" 
                                               id="data_vencimento_entrada_1" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label required" for="forma_pagamento_entrada_1">Forma de Pagamento</label>
                                        <select class="form-select" name="forma_pagamento_entrada_1" id="forma_pagamento_entrada_1" required>
                                            <option value="PIX" selected>PIX</option>
                                            <option value="BOLETO">Boleto</option>
                                            <option value="DINHEIRO">Dinheiro</option>
                                            <option value="CARTAO">Cart√£o</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Entrada 2 (Opcional - Inicialmente oculta) -->
                        <div class="card mb-3 entrada-item" id="entrada-2-card" style="display: none;" data-entrada="2">
                            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-cash-stack"></i> Entrada 2 (Opcional)</h6>
                                <button type="button" class="btn btn-sm btn-danger" id="removerEntrada2">
                                    <i class="bi bi-x-circle"></i> Remover
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label" for="valor_entrada_2_display">Valor da Entrada 2</label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="text" class="form-control valor-input valor-entrada" 
                                                   name="valor_entrada_2_display" id="valor_entrada_2_display">
                                            <input type="hidden" name="valor_entrada_2" id="valor_entrada_2" value="0">
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label" for="data_vencimento_entrada_2">Data de Vencimento</label>
                                        <input type="date" class="form-control" name="data_vencimento_entrada_2" 
                                               id="data_vencimento_entrada_2">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label" for="forma_pagamento_entrada_2">Forma de Pagamento</label>
                                        <select class="form-select" name="forma_pagamento_entrada_2" id="forma_pagamento_entrada_2">
                                            <option value="PIX" selected>PIX</option>
                                            <option value="BOLETO">Boleto</option>
                                            <option value="DINHEIRO">Dinheiro</option>
                                            <option value="CARTAO">Cart√£o</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bot√£o para adicionar segunda entrada -->
                    <div class="mb-3" id="btn-adicionar-entrada-container">
                        <button type="button" class="btn btn-outline-success" id="adicionarEntrada2">
                            <i class="bi bi-plus-circle"></i> Adicionar Segunda Entrada
                        </button>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="valor_parcela">Valor da Parcela</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control valor-input" name="valor_parcela_display" 
                                       id="valor_parcela_display" readonly>
                                <input type="hidden" name="valor_parcela" id="valor_parcela">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label required" for="frequencia_pagamento">Frequ√™ncia</label>
                            <select class="form-select" name="frequencia_pagamento" id="frequencia_pagamento" required>
                                <option value="MENSAL">Mensal</option>
                                <option value="QUINZENAL">Quinzenal</option>
                                <option value="SEMANAL">Semanal</option>
                            </select>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-outline-secondary btn-step" onclick="prevStep(1)">
                            <i class="bi bi-arrow-left me-2"></i>Voltar
                        </button>
                        <button type="button" class="btn btn-success btn-step" onclick="nextStep(3)">
                            Pr√≥xima Etapa <i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>

                <!-- ETAPA 3: Pagamento e Servi√ßos -->
                <div class="form-step" id="step3Content">
                    <h5 class="text-primary text-center mb-4">
                        <i class="bi bi-credit-card me-2"></i>3. Pagamento e Servi√ßos
                    </h5>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label required" for="data_vencimento_primeira">Vencimento da 1¬™ Parcela</label>
                            <input type="date" class="form-control" name="data_vencimento_primeira" 
                                   id="data_vencimento_primeira" required>
                            <small class="text-muted">Data de vencimento da primeira parcela do financiamento</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="forma_pagamento">Forma de Pag. das Parcelas</label>
                            <select class="form-select" name="forma_pagamento" id="forma_pagamento">
                                <option value="BOLETO">Boleto</option>
                                <option value="PIX">PIX</option>
                                <option value="DINHEIRO">Dinheiro</option>
                                <option value="CARTAO">Cart√£o</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Servi√ßos Contratados</label>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="limpa_nome" id="limpa_nome">
                            <label class="form-check-label" for="limpa_nome">Limpa Nome</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="retirada_travas" id="retirada_travas">
                            <label class="form-check-label" for="retirada_travas">Retirada de Travas</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="recuperacao_score" id="recuperacao_score">
                            <label class="form-check-label" for="recuperacao_score">Recupera√ß√£o de Score</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="prazo_pagamento_total">
                            <i class="fas fa-clock"></i> Prazo de Pagamento Total do Servi√ßo
                        </label>
                        <input type="text" class="form-control" name="prazo_pagamento_total" 
                               id="prazo_pagamento_total" readonly 
                               placeholder="Calculado automaticamente">
                    </div>

                    <div class="mb-3">
                        <label class="form-label required" for="data_inicio_servico">
                            <i class="fas fa-calendar-day"></i> Data de In√≠cio do Servi√ßo
                        </label>
                        <input type="date" class="form-control" name="data_inicio_servico" 
                               id="data_inicio_servico" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label required" for="dias_conclusao">
                            <i class="fas fa-calendar-alt"></i> Dias para Conclus√£o
                        </label>
                        <select class="form-select" name="dias_conclusao" id="dias_conclusao" required>
                            <option value="">Selecione o prazo...</option>
                            <option value="0">00 dias (Imediato)</option>
                            <option value="30">30 dias</option>
                            <option value="60">60 dias</option>
                            <option value="90">90 dias</option>
                            <option value="120">120 dias</option>
                            <option value="150">150 dias</option>
                            <option value="180" selected>180 dias</option>
                            <option value="210">210 dias</option>
                            <option value="240">240 dias</option>
                            <option value="270">270 dias</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="data_conclusao_prevista">
                            <i class="fas fa-calendar-check"></i> Data Para a Conclus√£o do Servi√ßo
                        </label>
                        <input type="date" class="form-control" name="data_conclusao_prevista" 
                               id="data_conclusao_prevista" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="observacoes">Observa√ß√µes</label>
                        <textarea class="form-control" name="observacoes" id="observacoes" rows="3"></textarea>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-outline-secondary btn-step" onclick="prevStep(2)">
                            <i class="bi bi-arrow-left me-2"></i>Voltar
                        </button>
                        <button type="submit" class="btn btn-success btn-step">
                            <i class="bi bi-check-circle me-2"></i>Finalizar Venda
                        </button>
                    </div>
                </div>
            </form>

            <!-- Bot√£o Voltar -->
            <div class="row mt-4">
                <div class="col-12">
                    <a href="{% url 'vendas:painel_leads_pagos' %}" class="btn btn-outline-secondary rounded-pill px-4 py-2">
                        <i class="bi bi-arrow-left-circle me-1"></i> Voltar para Painel
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStep = 1;

        function showStep(step) {
            // Oculta todas as etapas
            document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
            // Mostra a etapa atual
            document.getElementById(`step${step}Content`).classList.add('active');
            
            // Atualiza o indicador de progresso
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active', 'completed'));
            document.querySelectorAll('.step-line').forEach(l => l.classList.remove('active'));

            if (step >= 1) document.getElementById('step1').classList.add('active');
            if (step >= 2) {
                document.getElementById('step1').classList.add('completed');
                document.getElementById('line1').classList.add('active');
                document.getElementById('step2').classList.add('active');
            }
            if (step >= 3) {
                document.getElementById('step2').classList.add('completed');
                document.getElementById('line2').classList.add('active');
                document.getElementById('step3').classList.add('active');
            }
            
            currentStep = step;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function nextStep(step) {
            // Valida campos da etapa atual antes de avan√ßar
            const currentStepContent = document.getElementById(`step${currentStep}Content`);
            const inputs = currentStepContent.querySelectorAll('[required]');
            let valid = true;

            inputs.forEach(input => {
                if (!input.value.trim()) {
                    input.classList.add('is-invalid');
                    valid = false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });

            if (valid) {
                showStep(step);
            } else {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
            }
        }

        function prevStep(step) {
            showStep(step);
        }

        function pesquisarCaptador() {
            const captadorId = document.getElementById('captador_id').value.trim();
            const captadorInfo = document.getElementById('captadorInfo');
            
            if (!captadorId) {
                captadorInfo.textContent = 'Informe o ID do captador.';
                captadorInfo.className = 'form-text text-danger d-block mt-1';
                return;
            }

            fetch(`/accounts/api/buscar-captador/${captadorId}/`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        let nome = data.nome_completo || data.username;
                        captadorInfo.textContent = `‚úì Captador: ${nome} (${data.email})`;
                        captadorInfo.className = 'form-text text-success d-block mt-1';
                    } else {
                        captadorInfo.textContent = data.message || 'Captador n√£o encontrado.';
                        captadorInfo.className = 'form-text text-danger d-block mt-1';
                    }
                })
                .catch(() => {
                    captadorInfo.textContent = 'Erro ao buscar captador.';
                    captadorInfo.className = 'form-text text-danger d-block mt-1';
                });
        }

        function buscarCep() {
            const cep = document.getElementById('cep').value.replace(/\D/g, '');
            const cepInfo = document.getElementById('cepInfo');
            
            if (cep.length !== 8) {
                cepInfo.textContent = 'CEP deve ter 8 d√≠gitos.';
                cepInfo.className = 'form-text text-danger d-block mt-1';
                return;
            }

            cepInfo.textContent = 'Buscando CEP...';
            cepInfo.className = 'form-text text-info d-block mt-1';

            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(res => res.json())
                .then(data => {
                    if (data.erro) {
                        cepInfo.textContent = 'CEP n√£o encontrado.';
                        cepInfo.className = 'form-text text-danger d-block mt-1';
                        return;
                    }

                    // Preenche os campos
                    document.getElementById('rua').value = data.logradouro || '';
                    document.getElementById('bairro').value = data.bairro || '';
                    document.getElementById('cidade').value = data.localidade || '';
                    document.getElementById('estado').value = data.uf || '';

                    // Foco no n√∫mero
                    document.getElementById('numero').focus();

                    cepInfo.textContent = `‚úì Endere√ßo encontrado: ${data.logradouro}, ${data.bairro} - ${data.localidade}/${data.uf}`;
                    cepInfo.className = 'form-text text-success d-block mt-1';
                })
                .catch(() => {
                    cepInfo.textContent = 'Erro ao buscar CEP. Verifique sua conex√£o.';
                    cepInfo.className = 'form-text text-danger d-block mt-1';
                });
        }

        // ===== FORMATA√á√ÉO DE VALORES =====
        function formatarMoeda(valor) {
            // Converte n√∫mero para formato BR: 1234.56 -> 1.234,56
            // Se for string localizada (ex: "4.500,00"), desformatamos corretamente
            if (typeof valor === 'string') {
                valor = desformatarMoeda(valor) || 0;
            }
            return (Number(valor) || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function desformatarMoeda(valor) {
            // Remove formata√ß√£o: 1.234,56 -> 1234.56
            if (typeof valor === 'number') return valor;
            if (!valor) return 0;
            // Remove pontos (separador de milhares) e substitui v√≠rgula por ponto
            return parseFloat(valor.toString().replace(/\./g, '').replace(',', '.')) || 0;
        }

        function aplicarMascaraMoeda(inputDisplay, inputHidden) {
            // Formata enquanto digita (tempo real)
            inputDisplay.addEventListener('input', function(e) {
                let valor = e.target.value;
                
                // Remove tudo exceto n√∫meros
                valor = valor.replace(/\D/g, '');
                
                // Se vazio, limpa tudo
                if (!valor) {
                    e.target.value = '';
                    inputHidden.value = '0.00';
                    return;
                }
                
                // Converte para n√∫mero (centavos)
                let numero = parseInt(valor);
                
                // Converte centavos para reais (divide por 100)
                let real = (numero / 100).toFixed(2);
                
                // Formata com pontos e v√≠rgula
                let partes = real.split('.');
                let inteiro = partes[0];
                let decimal = partes[1];
                
                // Adiciona pontos nos milhares
                inteiro = inteiro.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                
                // Monta o valor formatado
                e.target.value = inteiro + ',' + decimal;
                
                // Atualiza campo hidden (valor sem formata√ß√£o)
                inputHidden.value = real;
            });

            // Ao sair do campo, dispara evento change para recalcular
            inputDisplay.addEventListener('blur', function(e) {
                // Dispara evento para recalcular parcela
                inputHidden.dispatchEvent(new Event('change'));
            });

            // Ao focar, seleciona todo o texto para facilitar edi√ß√£o
            inputDisplay.addEventListener('focus', function(e) {
                e.target.select();
            });
        }

        // Aplica m√°scara nos campos de valor
        const valorTotalDisplay = document.getElementById('valor_total_display');
        const valorTotalHidden = document.getElementById('valor_total');
        aplicarMascaraMoeda(valorTotalDisplay, valorTotalHidden);

        // M√∫ltiplas entradas
        const valorEntrada1Display = document.getElementById('valor_entrada_1_display');
        const valorEntrada1Hidden = document.getElementById('valor_entrada_1');
        aplicarMascaraMoeda(valorEntrada1Display, valorEntrada1Hidden);

        const valorEntrada2Display = document.getElementById('valor_entrada_2_display');
        const valorEntrada2Hidden = document.getElementById('valor_entrada_2');
        aplicarMascaraMoeda(valorEntrada2Display, valorEntrada2Hidden);

        const valorParcelaDisplay = document.getElementById('valor_parcela_display');
        const valorParcelaHidden = document.getElementById('valor_parcela');
        
        // üîß M√ÅSCARA DE CEP
        const cepInput = document.getElementById('cep');
        if (cepInput) {
            cepInput.addEventListener('input', function(e) {
                let valor = e.target.value.replace(/\D/g, ''); // Remove n√£o-num√©ricos
                if (valor.length > 8) valor = valor.substr(0, 8); // Limita a 8 d√≠gitos
                
                // Aplica m√°scara: 00000-000
                if (valor.length > 5) {
                    valor = valor.substr(0, 5) + '-' + valor.substr(5);
                }
                
                e.target.value = valor;
            });
            console.log('‚úÖ M√°scara de CEP aplicada');
        } else {
            console.warn('‚ö†Ô∏è Campo CEP n√£o encontrado');
        }
        
        // Parcela √© readonly, s√≥ precisa formatar
        valorParcelaDisplay.addEventListener('focus', function(e) {
            e.target.blur(); // N√£o permite editar
        });

        // === CONTROLE DE ENTRADAS ===
        document.getElementById('adicionarEntrada2').addEventListener('click', function() {
            document.getElementById('entrada-2-card').style.display = 'block';
            document.getElementById('btn-adicionar-entrada-container').style.display = 'none';
            
            // Tornar campos da entrada 2 obrigat√≥rios quando vis√≠vel
            document.getElementById('valor_entrada_2_display').required = true;
            document.getElementById('data_vencimento_entrada_2').required = true;
            document.getElementById('forma_pagamento_entrada_2').required = true;
        });

        document.getElementById('removerEntrada2').addEventListener('click', function() {
            document.getElementById('entrada-2-card').style.display = 'none';
            document.getElementById('btn-adicionar-entrada-container').style.display = 'block';
            
            // Limpar valores e remover obrigatoriedade
            valorEntrada2Display.value = '';
            valorEntrada2Hidden.value = '0';
            document.getElementById('data_vencimento_entrada_2').value = '';
            document.getElementById('forma_pagamento_entrada_2').value = 'PIX';
            
            document.getElementById('valor_entrada_2_display').required = false;
            document.getElementById('data_vencimento_entrada_2').required = false;
            document.getElementById('forma_pagamento_entrada_2').required = false;
            
            // Recalcular parcelas
            calcularParcela();
        });

        // Valida√ß√£o: soma das entradas n√£o pode exceder valor total
        function validarSomaEntradas() {
            const valorTotal = desformatarMoeda(valorTotalDisplay.value) || 0;
            const valorEntrada1 = desformatarMoeda(valorEntrada1Display.value) || 0;
            const valorEntrada2 = desformatarMoeda(valorEntrada2Display.value) || 0;
            const somaEntradas = valorEntrada1 + valorEntrada2;
            
            if (somaEntradas > valorTotal) {
                showAlert('A soma das entradas (R$ ' + formatarMoeda(somaEntradas) + ') n√£o pode ser maior que o valor total (R$ ' + formatarMoeda(valorTotal) + ')', 'warning');
                return false;
            }
            return true;
        }

        // Adicionar listeners para valida√ß√£o
        valorEntrada1Display.addEventListener('blur', validarSomaEntradas);
        valorEntrada2Display.addEventListener('blur', validarSomaEntradas);
        valorTotalDisplay.addEventListener('blur', validarSomaEntradas);

        // Inicializa valor total com valor da pr√©-venda
        const valorInicialTotal = parseFloat('{{ pre_venda.valor_total|default:pre_venda.valor_proposto|unlocalize }}');
        const qtdInicialParcelas = parseInt('{{ pre_venda.quantidade_parcelas|default:"1" }}');
        
        valorTotalDisplay.value = formatarMoeda(valorInicialTotal);
        valorTotalHidden.value = (Number(valorInicialTotal) || 0).toFixed(2);

        // Carregar entradas da pr√©-venda se existirem
        try {
            {% if pre_venda.entradas.exists %}
                console.log('üîç Carregando entradas da pr√©-venda...');
                let entradasCarregadas = 0;
                {% for entrada in pre_venda.entradas.all %}
                    entradasCarregadas++;
                    console.log('   Entrada {{ entrada.numero_entrada }}: R$ {{ entrada.valor }} - Venc: {{ entrada.data_vencimento|date:"d/m/Y" }} - Forma: {{ entrada.forma_pagamento }}');
                    
                    {% if entrada.numero_entrada == 1 %}
                        valorEntrada1Display.value = formatarMoeda({{ entrada.valor|unlocalize }});
                        valorEntrada1Hidden.value = ({{ entrada.valor|unlocalize }}).toFixed(2);
                        document.getElementById('data_vencimento_entrada_1').value = '{{ entrada.data_vencimento|date:"Y-m-d" }}';
                        document.getElementById('forma_pagamento_entrada_1').value = '{{ entrada.forma_pagamento }}';
                        console.log('   ‚úÖ Entrada 1 carregada nos campos');
                    {% elif entrada.numero_entrada == 2 %}
                        // Mostrar card da entrada 2
                        const entrada2Card = document.getElementById('entrada-2-card');
                        const btnAddEntrada2 = document.getElementById('btn-adicionar-entrada-container');
                        
                        if (entrada2Card) {
                            entrada2Card.style.display = 'block';
                            console.log('   üì¶ Card Entrada 2 exibido');
                            
                            // Tornar campos obrigat√≥rios
                            const valorEntrada2Req = document.getElementById('valor_entrada_2_display');
                            const dataEntrada2Req = document.getElementById('data_vencimento_entrada_2');
                            const formaEntrada2Req = document.getElementById('forma_pagamento_entrada_2');
                            
                            if (valorEntrada2Req) valorEntrada2Req.required = true;
                            if (dataEntrada2Req) dataEntrada2Req.required = true;
                            if (formaEntrada2Req) formaEntrada2Req.required = true;
                        } else {
                            console.error('   ‚ùå Card entrada-2-card n√£o encontrado!');
                        }
                        
                        if (btnAddEntrada2) {
                            btnAddEntrada2.style.display = 'none';
                            console.log('   üîò Bot√£o adicionar entrada ocultado');
                        }
                        
                        valorEntrada2Display.value = formatarMoeda({{ entrada.valor|unlocalize }});
                        valorEntrada2Hidden.value = ({{ entrada.valor|unlocalize }}).toFixed(2);
                        
                        const dataVenc2 = document.getElementById('data_vencimento_entrada_2');
                        const formaPgto2 = document.getElementById('forma_pagamento_entrada_2');
                        
                        if (dataVenc2) {
                            dataVenc2.value = '{{ entrada.data_vencimento|date:"Y-m-d" }}';
                            console.log('   üìÖ Data vencimento 2:', dataVenc2.value);
                        }
                        if (formaPgto2) {
                            formaPgto2.value = '{{ entrada.forma_pagamento }}';
                            console.log('   üí≥ Forma pagamento 2:', formaPgto2.value);
                        }
                        
                        console.log('   ‚úÖ Entrada 2 carregada nos campos e card exibido');
                    {% endif %}
                {% endfor %}
                console.log(`‚úÖ Total de ${entradasCarregadas} entrada(s) carregada(s)`);
            {% else %}
                // Fallback: usar valor_entrada da pr√©-venda se n√£o houver entradas detalhadas
                console.log('‚ö†Ô∏è Nenhuma entrada detalhada encontrada, usando valor_entrada da pr√©-venda');
                const valorInicialEntrada = parseFloat('{{ pre_venda.valor_entrada|default:"0"|unlocalize }}');
                valorEntrada1Display.value = formatarMoeda(valorInicialEntrada);
                valorEntrada1Hidden.value = (Number(valorInicialEntrada) || 0).toFixed(2);
            {% endif %}
        } catch (erro) {
            console.error('‚ùå Erro ao carregar entradas:', erro);
            console.error('Stack trace:', erro.stack);
        }
        
        // Inicializa quantidade de parcelas
        document.getElementById('quantidade_parcelas').value = qtdInicialParcelas;
        
        // Inicializa frequ√™ncia com a pr√©-venda (se dispon√≠vel)
        try {
            const freq = '{{ pre_venda.frequencia_pagamento|default:"MENSAL" }}';
            document.getElementById('frequencia_pagamento').value = freq;
            document.getElementById('resumoFrequencia').textContent = freq;
        } catch (e) {}

        // Calcular valor da parcela automaticamente
        valorTotalHidden.addEventListener('change', calcularParcela);
        valorEntrada1Hidden.addEventListener('change', calcularParcela);
        valorEntrada2Hidden.addEventListener('change', calcularParcela);
        document.getElementById('quantidade_parcelas').addEventListener('input', calcularParcela);

        // Calcular inicialmente para preencher o campo de parcela
        calcularParcela();

        function calcularParcela() {
            const total = parseFloat(valorTotalHidden.value) || 0;
            const entrada1 = parseFloat(valorEntrada1Hidden.value) || 0;
            const entrada2 = parseFloat(valorEntrada2Hidden.value) || 0;
            const entradaTotal = entrada1 + entrada2;
            const qtdParcelas = parseInt(document.getElementById('quantidade_parcelas').value) || 0;
            
            // Validar que soma das entradas n√£o excede o total
            if (entradaTotal > total) {
                showAlert('Soma das entradas (R$ ' + formatarMoeda(entradaTotal) + ') n√£o pode ser maior que o total (R$ ' + formatarMoeda(total) + ')', 'warning');
                return;
            }

            const saldo = Math.max(0, total - entradaTotal);
            
            if (qtdParcelas > 0 && saldo > 0) {
                const valorParcela = saldo / qtdParcelas;
                valorParcelaHidden.value = valorParcela.toFixed(2);
                valorParcelaDisplay.value = formatarMoeda(valorParcela);
            } else {
                valorParcelaHidden.value = '0.00';
                valorParcelaDisplay.value = formatarMoeda(0);
            }
        }

        // Valida√ß√£o final no submit para garantir integridade
        document.getElementById('vendaForm').addEventListener('submit', function(event) {
            const total = parseFloat(valorTotalHidden.value) || 0;
            const entrada1 = parseFloat(valorEntrada1Hidden.value) || 0;
            const entrada2 = parseFloat(valorEntrada2Hidden.value) || 0;
            const entradaTotal = entrada1 + entrada2;

            if (entradaTotal > total) {
                event.preventDefault();
                showAlert('O valor total das entradas n√£o pode ser maior que o valor total. Ajuste os valores antes de submeter.', 'danger');
                return false;
            }
            
            if (!validarSomaEntradas()) {
                event.preventDefault();
                return false;
            }

            if (parcela > total) {
                event.preventDefault();
                alert('O valor da parcela n√£o pode ser maior que o valor total. Ajuste os valores antes de submeter.');
                return false;
            }

            // Normal submit
            document.getElementById('loadingOverlay').style.display = 'flex';
        });

        // M√°scaras de input
        document.getElementById('cpf').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            e.target.value = value;
        });

        document.getElementById('telefone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
            value = value.replace(/(\d)(\d{4})$/, '$1-$2');
            e.target.value = value;
        });

        document.getElementById('cep').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/^(\d{5})(\d)/, '$1-$2');
            e.target.value = value;
        });

        // Enter no CEP dispara busca
        document.getElementById('cep').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                buscarCep();
            }
        });

        // Converte estado para mai√∫scula automaticamente
        document.getElementById('estado').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });

        // ========== C√ÅLCULO DE PRAZOS E DATAS ==========
        
        // Fun√ß√£o para adicionar dias a uma data (considera apenas dias corridos)
        function adicionarDias(data, dias) {
            const resultado = new Date(data);
            resultado.setDate(resultado.getDate() + parseInt(dias));
            return resultado;
        }

        // Fun√ß√£o para formatar data para input type="date" (YYYY-MM-DD)
        function formatarDataInput(data) {
            const ano = data.getFullYear();
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const dia = String(data.getDate()).padStart(2, '0');
            return `${ano}-${mes}-${dia}`;
        }

        // Calcular data de conclus√£o quando data_inicio ou dias_conclusao mudar
        function calcularDataConclusao() {
            const dataInicio = document.getElementById('data_inicio_servico').value;
            const diasConclusao = document.getElementById('dias_conclusao').value;
            
            if (dataInicio && diasConclusao) {
                const dataInicioParsed = new Date(dataInicio + 'T00:00:00');
                const dataConclusao = adicionarDias(dataInicioParsed, diasConclusao);
                document.getElementById('data_conclusao_prevista').value = formatarDataInput(dataConclusao);
            }
        }

        // Calcular prazo total de pagamento
        function calcularPrazoPagamento() {
            const qtdParcelas = parseInt(document.getElementById('quantidade_parcelas').value) || 1;
            const frequencia = document.getElementById('frequencia_pagamento').value || 'MENSAL';
            
            let diasEntreParcelas = 30; // Padr√£o mensal
            if (frequencia === 'SEMANAL') diasEntreParcelas = 7;
            else if (frequencia === 'QUINZENAL') diasEntreParcelas = 15;
            else if (frequencia === 'MENSAL') diasEntreParcelas = 30;
            
            const prazoTotal = qtdParcelas * diasEntreParcelas;
            
            // Arredondar para os valores permitidos
            const valoresPermitidos = [30, 60, 90, 120, 150, 180, 210, 240, 270];
            const prazoArredondado = valoresPermitidos.reduce((prev, curr) => 
                Math.abs(curr - prazoTotal) < Math.abs(prev - prazoTotal) ? curr : prev
            );
            
            document.getElementById('prazo_pagamento_total').value = `${prazoArredondado} dias`;
        }

        // Event listeners para os campos de prazo
        document.getElementById('data_inicio_servico').addEventListener('change', calcularDataConclusao);
        document.getElementById('dias_conclusao').addEventListener('change', calcularDataConclusao);
        
        document.getElementById('quantidade_parcelas').addEventListener('input', calcularPrazoPagamento);
        document.getElementById('frequencia_pagamento').addEventListener('change', calcularPrazoPagamento);

        // Inicializar prazo de pagamento
        calcularPrazoPagamento();

        // ========== FIM C√ÅLCULO DE PRAZOS ==========

        // Mostrar loading ao submeter
        document.getElementById('vendaForm').addEventListener('submit', function() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        });

        // Inicializa na etapa 1
        showStep(1);
        
        // Calcula parcela inicial
        calcularParcela();
    </script>
</body>
</html>
