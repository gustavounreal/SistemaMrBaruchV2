{% extends 'base/base.html' %}
{% load static %}

{% block title %}Dashboard KPIs - Comercial 2{% endblock %}

{% block extra_head %}
<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="{% static 'css/comercial2.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1><i class="bi bi-graph-up"></i> Dashboard KPIs - Comercial 2</h1>
      <p class="text-muted mb-0">Métricas e performance de repescagem</p>
    </div>
    <div>
      <a href="{% url 'relatorios:painel_central' %}" class="btn btn-outline-primary">
        <i class="bi bi-arrow-left"></i> Voltar ao Painel de Relatórios
      </a>
    </div>
  </div>

  <!-- Filtro de Período -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Período de Análise</label>
          <select name="periodo" class="form-select" onchange="this.form.submit()">
            <option value="7" {% if periodo_dias == 7 %}selected{% endif %}>Últimos 7 dias</option>
            <option value="30" {% if periodo_dias == 30 %}selected{% endif %}>Últimos 30 dias</option>
            <option value="60" {% if periodo_dias == 60 %}selected{% endif %}>Últimos 60 dias</option>
            <option value="90" {% if periodo_dias == 90 %}selected{% endif %}>Últimos 90 dias</option>
            <option value="365" {% if periodo_dias == 365 %}selected{% endif %}>Último ano</option>
          </select>
        </div>
      </form>
    </div>
  </div>

  <!-- Cards de Estatísticas -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="text-primary mb-0">{{ stats.total_periodo }}</h3>
          <p class="text-muted mb-0">Repescagens no Período</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="text-success mb-0">{{ stats.convertidos_periodo }}</h3>
          <p class="text-muted mb-0">Convertidos no Período</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="text-info mb-0">{{ stats.taxa_conversao_periodo }}%</h3>
          <p class="text-muted mb-0">Taxa de Conversão</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="text-warning mb-0">{{ stats.tempo_medio_dias }} dias</h3>
          <p class="text-muted mb-0">Tempo Médio</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Cards Resumo Global -->
  <div class="row g-3 mb-4">
    <div class="col-md-2">
      <div class="card text-center bg-light">
        <div class="card-body">
          <h5 class="mb-0">{{ stats.total_geral }}</h5>
          <small class="text-muted">Total Geral</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card text-center bg-warning bg-opacity-10">
        <div class="card-body">
          <h5 class="mb-0">{{ stats.pendentes }}</h5>
          <small class="text-muted">Pendentes</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card text-center bg-info bg-opacity-10">
        <div class="card-body">
          <h5 class="mb-0">{{ stats.em_contato }}</h5>
          <small class="text-muted">Em Contato</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card text-center bg-success bg-opacity-10">
        <div class="card-body">
          <h5 class="mb-0">{{ stats.convertidos }}</h5>
          <small class="text-muted">Convertidos</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card text-center bg-secondary bg-opacity-10">
        <div class="card-body">
          <h5 class="mb-0">{{ stats.sem_interesse }}</h5>
          <small class="text-muted">Sem Interesse</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card text-center bg-danger bg-opacity-10">
        <div class="card-body">
          <h5 class="mb-0">{{ stats.lead_lixo }}</h5>
          <small class="text-muted">Lead Lixo</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos -->
  <div class="row g-4 mb-4">
    <!-- Distribuição por Status -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Distribuição por Status</h5>
        </div>
        <div class="card-body">
          <canvas id="chartStatus" height="250"></canvas>
        </div>
      </div>
    </div>

    <!-- Top Motivos de Conversão -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Top 5 Motivos que Convertem</h5>
        </div>
        <div class="card-body">
          <canvas id="chartMotivos" height="250"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance por Consultor -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-people"></i> Performance por Consultor</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Consultor</th>
              <th class="text-center">Total Atendimentos</th>
              <th class="text-center">Convertidos</th>
              <th class="text-center">Taxa de Conversão</th>
            </tr>
          </thead>
          <tbody>
            {% for perf in performance_consultores %}
            <tr>
              <td>
                <i class="bi bi-person-circle"></i>
                {{ perf.consultor_repescagem__first_name }} {{ perf.consultor_repescagem__last_name }}
                <small class="text-muted">({{ perf.consultor_repescagem__username }})</small>
              </td>
              <td class="text-center">{{ perf.total_atendimentos }}</td>
              <td class="text-center">
                <span class="badge bg-success">{{ perf.total_convertidos }}</span>
              </td>
              <td class="text-center">
                <strong class="{% if perf.taxa_conversao >= 20 %}text-success{% elif perf.taxa_conversao >= 10 %}text-warning{% else %}text-danger{% endif %}">
                  {{ perf.taxa_conversao }}%
                </strong>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="text-center text-muted">Nenhum consultor com atendimentos</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Top Motivos Gerais -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-list-ol"></i> Top 5 Motivos de Recusa Gerais</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Motivo</th>
              <th class="text-center">Quantidade</th>
            </tr>
          </thead>
          <tbody>
            {% for motivo in motivos_gerais %}
            <tr>
              <td>{{ motivo.motivo_recusa__nome }}</td>
              <td class="text-center"><span class="badge bg-primary">{{ motivo.total }}</span></td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="2" class="text-center text-muted">Sem dados</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// Dados para os gráficos
const statusData = {{ distribuicao_status|safe }};
const motivosData = {{ motivos_conversao|safe }};

// Gráfico de Pizza - Status
const ctxStatus = document.getElementById('chartStatus').getContext('2d');
new Chart(ctxStatus, {
  type: 'doughnut',
  data: {
    labels: statusData.map(item => item.status),
    datasets: [{
      data: statusData.map(item => item.total),
      backgroundColor: [
        '#6f42c1', '#0d6efd', '#198754', '#ffc107', '#dc3545', '#6c757d'
      ]
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'right'
      }
    }
  }
});

// Gráfico de Barras - Motivos de Conversão
const ctxMotivos = document.getElementById('chartMotivos').getContext('2d');
new Chart(ctxMotivos, {
  type: 'bar',
  data: {
    labels: motivosData.map(item => item.motivo_recusa__nome),
    datasets: [{
      label: 'Conversões',
      data: motivosData.map(item => item.total_conversoes),
      backgroundColor: '#198754'
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: {
        beginAtZero: true
      }
    }
  }
});

// Script para formatar valores monetários no padrão brasileiro
document.addEventListener('DOMContentLoaded', function() {
    function formatarMoeda(valor) {
        let numero = valor.replace('R$', '').trim();
        numero = parseFloat(numero);
        
        if (isNaN(numero)) {
            return valor;
        }
        
        return 'R$ ' + numero.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    // Formata todos os valores monetários
    const elementosMonetarios = document.querySelectorAll('.card-value, .metric-value, .valor-monetario, [data-format="currency"]');
    
    elementosMonetarios.forEach(function(elemento) {
        const texto = elemento.textContent;
        if (texto.includes('R$')) {
            elemento.textContent = formatarMoeda(texto);
        }
    });
});
</script>
{% endblock %}
