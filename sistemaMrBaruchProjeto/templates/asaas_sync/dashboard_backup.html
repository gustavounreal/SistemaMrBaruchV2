{% extends 'base/base.html' %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}Dashboard Asaas - Sistema Mr. Baruch{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <h2 class="mb-3 mb-md-0"><i class="fas fa-chart-line me-2"></i>Dashboard Asaas - Sincronização Automática</h2>
                <div class="d-flex gap-3 flex-wrap justify-content-end">
                    <!-- Botão Asaas 1 (Principal) -->
                    <button class="btn btn-primary btn-lg" onclick="sincronizarAsaas('principal')" title="Sincroniza automaticamente: baixa, atualiza, adiciona e exclui">
                        <i class="fas fa-sync me-2"></i>Sincronizar Asaas 1
                    </button>
                    
                    <!-- Botão Asaas 2 (Alternativo) -->
                    <button class="btn btn-secondary btn-lg" onclick="sincronizarAsaas('alternativo')" title="Sincroniza automaticamente: baixa, atualiza, adiciona e exclui">
                        <i class="fas fa-sync me-2"></i>Sincronizar Asaas 2
                    </button>
                </div>
            </div>
            <div class="mt-2">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>Sincronização automática:</strong> Ao clicar, o sistema baixa todos os dados do Asaas, atualiza registros existentes, adiciona novos e remove o que não existe mais no Asaas.
                </small>
            </div>
            {% if ultima_sync %}
            <small class="text-muted d-block mt-2">
                Última sincronização: {{ ultima_sync.data_inicio|date:"d/m/Y H:i" }} 
                - Status: 
                {% if ultima_sync.status == 'SUCESSO' %}
                    <span class="badge bg-success">{{ ultima_sync.get_status_display }}</span>
                {% elif ultima_sync.status == 'PARCIAL' %}
                    <span class="badge bg-warning">{{ ultima_sync.get_status_display }}</span>
                {% else %}
                    <span class="badge bg-danger">{{ ultima_sync.get_status_display }}</span>
                {% endif %}
            </small>
            {% endif %}
        </div>
    </div>

    <!-- Área de Feedback em Tempo Real -->
    <div class="row mb-4" id="feedbackArea" style="display: none;">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-tasks me-2"></i><span id="tituloFeedback">Sincronização em Andamento</span></h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="barraFeedback" role="progressbar" style="width: 0%">
                                <span id="textoProgresso">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info" id="statusFeedback">
                        <i class="fas fa-spinner fa-spin me-2"></i><span id="mensagemFeedback">Iniciando...</span>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3">
                            <div class="border rounded p-3 text-center">
                                <h3 class="mb-0" id="statClientes">0</h3>
                                <small class="text-muted">Clientes</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3 text-center">
                                <h3 class="mb-0" id="statCobrancas">0</h3>
                                <small class="text-muted">Cobranças</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3 text-center">
                                <h3 class="mb-0" id="statTempo">0s</h3>
                                <small class="text-muted">Duração</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3 text-center">
                                <h3 class="mb-0"><span class="badge bg-secondary" id="statStatus">Em andamento</span></h3>
                                <small class="text-muted">Status</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ASAAS 1 (Principal) - Cards de Estatísticas -->
    <div class="row mb-3">
        <div class="col-12">
            <h4 class="mb-3"><i class="fas fa-server me-2 text-primary"></i>ASAAS 1 (Principal)</h4>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total de Clientes</h6>
                            <h3 class="mb-0">{{ total_clientes }}</h3>
                        </div>
                        <i class="fas fa-users fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Recebido</h6>
                            <h3 class="mb-0">{{ total_recebido|moeda_br }}</h3>
                        </div>
                        <i class="fas fa-check-circle fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Pendente</h6>
                            <h3 class="mb-0">{{ total_pendente|moeda_br }}</h3>
                        </div>
                        <i class="fas fa-clock fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Vencido</h6>
                            <h3 class="mb-0">{{ total_vencido|moeda_br }}</h3>
                        </div>
                        <i class="fas fa-exclamation-triangle fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ASAAS 2 (Alternativo) - Cards de Estatísticas -->
    <div class="row mb-3">
        <div class="col-12">
            <h4 class="mb-3"><i class="fas fa-server me-2 text-secondary"></i>ASAAS 2 (Alternativo)</h4>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total de Clientes</h6>
                            <h3 class="mb-0">{{ total_clientes2 }}</h3>
                        </div>
                        <i class="fas fa-users fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Recebido</h6>
                            <h3 class="mb-0">{{ total_recebido2|moeda_br }}</h3>
                        </div>
                        <i class="fas fa-check-circle fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Pendente</h6>
                            <h3 class="mb-0">{{ total_pendente2|moeda_br }}</h3>
                        </div>
                        <i class="fas fa-clock fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Vencido</h6>
                            <h3 class="mb-0">{{ total_vencido2|moeda_br }}</h3>
                        </div>
                        <i class="fas fa-exclamation-triangle fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cobranças por Status - ASAAS 1 e 2 lado a lado -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Cobranças por Status - Asaas 1</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th class="text-end">Quantidade</th>
                                    <th class="text-end">Valor Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cobrancas_por_status %}
                                <tr>
                                    <td>
                                        {% if item.status == 'RECEIVED' or item.status == 'CONFIRMED' %}
                                            <span class="badge bg-success">
                                                {% if item.status == 'RECEIVED' %}Recebida{% else %}Confirmada{% endif %}
                                            </span>
                                        {% elif item.status == 'PENDING' %}
                                            <span class="badge bg-warning">Pendente</span>
                                        {% elif item.status == 'OVERDUE' %}
                                            <span class="badge bg-danger">Vencida</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ item.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">{{ item.total }}</td>
                                    <td class="text-end">R$ {{ item.valor_total|floatformat:2 }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">Nenhuma cobrança encontrada</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Cobranças por Status - Asaas 2</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th class="text-end">Quantidade</th>
                                    <th class="text-end">Valor Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cobrancas_por_status2 %}
                                <tr>
                                    <td>
                                        {% if item.status == 'RECEIVED' or item.status == 'CONFIRMED' %}
                                            <span class="badge bg-success">
                                                {% if item.status == 'RECEIVED' %}Recebida{% else %}Confirmada{% endif %}
                                            </span>
                                        {% elif item.status == 'PENDING' %}
                                            <span class="badge bg-warning">Pendente</span>
                                        {% elif item.status == 'OVERDUE' %}
                                            <span class="badge bg-danger">Vencida</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ item.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">{{ item.total }}</td>
                                    <td class="text-end">R$ {{ item.valor_total|floatformat:2 }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">Nenhuma cobrança encontrada</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Histórico de Sincronizações -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Histórico de Sincronizações</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                    <th class="text-end">Clientes</th>
                                    <th class="text-end">Cobranças</th>
                                    <th class="text-end">Duração</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sync in ultimas_syncs %}
                                <tr>
                                    <td><small>{{ sync.data_inicio|date:"d/m H:i" }}</small></td>
                                    <td>
                                        {% if 'AUTO_SYNC' in sync.tipo_sincronizacao %}
                                            <span class="badge bg-success" title="Sincronização Automática">
                                                <i class="fas fa-sync"></i> Auto
                                            </span>
                                        {% elif sync.tipo_sincronizacao == 'ALTERNATIVO' %}
                                            <span class="badge bg-secondary">Asaas 2</span>
                                        {% else %}
                                            <span class="badge bg-primary">Asaas 1</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if sync.status == 'SUCESSO' %}
                                            <span class="badge bg-success">✓</span>
                                        {% elif sync.status == 'EM_ANDAMENTO' %}
                                            <span class="badge bg-warning"><i class="fas fa-spinner fa-spin"></i></span>
                                        {% else %}
                                            <span class="badge bg-danger">✗</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <small>{{ sync.total_clientes }}</small>
                                    </td>
                                    <td class="text-end">
                                        <small><strong>{{ sync.total_cobrancas }}</strong></small>
                                    </td>
                                    <td class="text-end">
                                        <small>{{ sync.duracao_segundos|default:"-" }}s</small>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">Nenhuma sincronização realizada</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let intervalFeedback = null;
let tempoInicio = null;

function sincronizarAsaas(conta) {
    if (!confirm(`Sincronizar Asaas ${conta === 'principal' ? '1 (Principal)' : '2 (Alternativo)'}?\n\nEsta operação irá:\n✓ Baixar todos os dados do Asaas\n✓ Atualizar registros existentes\n✓ Adicionar novos registros\n✓ Remover o que não existe mais no Asaas\n\nContinuar?`)) {
        return;
    }
    
    mostrarFeedback(`Sincronizando Asaas ${conta === 'principal' ? '1 (Principal)' : '2 (Alternativo)'}...`);
    
    fetch('{% url "asaas_sync:baixar_dados_asaas" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `conta=${conta}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            adicionarLog(`✓ Sincronização iniciada! Log ID: ${data.log_id}`);
            monitorarOperacao(data.log_id);
        } else {
            mostrarErro(data.message);
        }
    })
    .catch(error => {
        mostrarErro(`Erro: ${error}`);
    });
}

function monitorarOperacao(logId) {
    if (intervalFeedback) {
        clearInterval(intervalFeedback);
    }
    
    tempoInicio = Date.now();
    let progresso = 10;
    
    intervalFeedback = setInterval(() => {
        const segundos = Math.floor((Date.now() - tempoInicio) / 1000);
        document.getElementById('statTempo').textContent = `${segundos}s`;
        
        if (progresso < 95) {
            progresso += 1;
            atualizarProgresso(progresso);
        }
        
        fetch(`/asaas-sync/status-operacao/${logId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.status === 'SUCESSO') {
                        clearInterval(intervalFeedback);
                        mostrarSucesso('Sincronização concluída!', data);
                        setTimeout(() => location.reload(), 3000);
                    } else if (data.status === 'ERRO') {
                        clearInterval(intervalFeedback);
                        mostrarErro(data.erros || 'Erro desconhecido');
                    }
                }
            })
            .catch(error => console.error('Erro ao verificar status:', error));
    }, 2000);
}

function mostrarFeedback(titulo) {
    document.getElementById('feedbackArea').style.display = 'block';
    document.getElementById('feedbackArea').scrollIntoView({ behavior: 'smooth', block: 'start' });
    document.getElementById('tituloFeedback').textContent = titulo;
    document.getElementById('statusFeedback').className = 'alert alert-info';
    document.getElementById('mensagemFeedback').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Iniciando...';
    document.getElementById('statClientes').textContent = '0';
    document.getElementById('statCobrancas').textContent = '0';
    document.getElementById('statTempo').textContent = '0s';
    document.getElementById('statStatus').textContent = 'Em andamento';
    document.getElementById('statStatus').className = 'badge bg-secondary';
    atualizarProgresso(0);
}

function atualizarProgresso(percent) {
    document.getElementById('barraFeedback').style.width = `${percent}%`;
    document.getElementById('textoProgresso').textContent = `${Math.round(percent)}%`;
}

function adicionarLog(mensagem) {
    document.getElementById('mensagemFeedback').textContent = mensagem;
}

function mostrarSucesso(mensagem, data) {
    document.getElementById('statusFeedback').className = 'alert alert-success';
    document.getElementById('mensagemFeedback').innerHTML = '<i class="fas fa-check-circle me-2"></i>' + mensagem;
    document.getElementById('statStatus').textContent = 'Sucesso';
    document.getElementById('statStatus').className = 'badge bg-success';
    document.getElementById('barraFeedback').classList.remove('progress-bar-animated');
    document.getElementById('barraFeedback').classList.add('bg-success');
    atualizarProgresso(100);
    
    if (data.total_clientes) {
        document.getElementById('statClientes').textContent = data.total_clientes;
    }
    if (data.total_cobrancas) {
        document.getElementById('statCobrancas').textContent = data.total_cobrancas;
    }
}

function mostrarErro(mensagem) {
    document.getElementById('statusFeedback').className = 'alert alert-danger';
    document.getElementById('mensagemFeedback').innerHTML = `<i class="fas fa-times-circle me-2"></i>Erro: ${mensagem}`;
    document.getElementById('statStatus').textContent = 'Erro';
    document.getElementById('statStatus').className = 'badge bg-danger';
    document.getElementById('barraFeedback').classList.remove('progress-bar-animated');
    document.getElementById('barraFeedback').classList.add('bg-danger');
}
</script>
{% endblock %}
