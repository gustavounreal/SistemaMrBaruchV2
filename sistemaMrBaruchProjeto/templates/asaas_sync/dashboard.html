{% extends 'base/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard Asaas - Sistema Mr. Baruch{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Alerta sobre Token Alternativo (Colaps√°vel) -->
    <div class="mb-3">
        <button class="btn btn-outline-warning btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#infoSincronizacao" aria-expanded="false" aria-controls="infoSincronizacao">
            <i class="fas fa-info-circle me-2"></i>Informa√ß√µes sobre Sincroniza√ß√£o Alternativa
            <i class="fas fa-chevron-down ms-2"></i>
        </button>
    </div>
    
    <div class="collapse" id="infoSincronizacao">
        <div class="alert alert-warning alert-dismissible" role="alert">
            <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Informa√ß√£o sobre Sincroniza√ß√£o Alternativa</h5>
            <p class="mb-2">
                <strong>Asaas 1 (Principal):</strong> Sincroniza com a conta Asaas principal<br>
                <strong>Asaas 2 (Alternativo):</strong> Sincroniza com uma conta Asaas secund√°ria
            </p>
            <hr>
            <p class="mb-0">
                <small>
                    ‚ö†Ô∏è <strong>IMPORTANTE:</strong> Se a sincroniza√ß√£o alternativa retornar erro, pode ser:
                    <br>‚Ä¢ Credenciais expiradas
                    <br>‚Ä¢ Credenciais inv√°lidas
                    <br>‚Ä¢ Sem permiss√µes adequadas
                    <br><br>
                    üí° <strong>Solu√ß√£o:</strong> Verifique as credenciais da conta Asaas alternativa
                </small>
            </p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-chart-line me-2"></i>Dashboard Asaas - Dados Sincronizados</h2>
                <div>
                    <button class="btn btn-primary me-2" onclick="sincronizarAgora()">
                        <i class="fas fa-sync me-2"></i>Sincronizar(Asaas 1)
                    </button>
                    <button class="btn btn-secondary" onclick="sincronizarAsaasAlternativo()">
                        <i class="fas fa-download me-2"></i>Sincronizar(Asaas 2)
                    </button>
                </div>
            </div>
            {% if ultima_sync %}
            <small class="text-muted">
                √öltima sincroniza√ß√£o: {{ ultima_sync.data_inicio|date:"d/m/Y H:i" }} 
                - Status: 
                {% if ultima_sync.status == 'SUCESSO' %}
                    <span class="badge bg-success">{{ ultima_sync.get_status_display }}</span>
                {% elif ultima_sync.status == 'PARCIAL' %}
                    <span class="badge bg-warning">{{ ultima_sync.get_status_display }}</span>
                {% else %}
                    <span class="badge bg-danger">{{ ultima_sync.get_status_display }}</span>
                {% endif %}
            </small>
            {% endif %}
        </div>
    </div>

    <!-- Cards de Estat√≠sticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total de Clientes</h6>
                            <h3 class="mb-0">{{ total_clientes }}</h3>
                        </div>
                        <i class="fas fa-users fa-3x opacity-50"></i>
                    </div>
                    <a href="{% url 'asaas_sync:lista_clientes' %}" class="text-white d-block mt-2">
                        <small>Ver todos <i class="fas fa-arrow-right ms-1"></i></small>
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Recebido</h6>
                            <h3 class="mb-0">R$ {{ total_recebido|floatformat:2 }}</h3>
                        </div>
                        <i class="fas fa-check-circle fa-3x opacity-50"></i>
                    </div>
                    <small class="text-white-50 d-block mt-2">Cobran√ßas pagas</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Pendente</h6>
                            <h3 class="mb-0">R$ {{ total_pendente|floatformat:2 }}</h3>
                        </div>
                        <i class="fas fa-clock fa-3x opacity-50"></i>
                    </div>
                    <small class="text-white-50 d-block mt-2">Aguardando pagamento</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Vencido</h6>
                            <h3 class="mb-0">R$ {{ total_vencido|floatformat:2 }}</h3>
                        </div>
                        <i class="fas fa-exclamation-triangle fa-3x opacity-50"></i>
                    </div>
                    <small class="text-white-50 d-block mt-2">Cobran√ßas vencidas</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Cobran√ßas por Status -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Cobran√ßas por Status</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th class="text-end">Quantidade</th>
                                    <th class="text-end">Valor Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cobrancas_por_status %}
                                <tr>
                                    <td>
                                        {% if item.status == 'RECEIVED' or item.status == 'CONFIRMED' %}
                                            <span class="badge bg-success">
                                                {% if item.status == 'RECEIVED' %}Recebida{% else %}Confirmada{% endif %}
                                            </span>
                                        {% elif item.status == 'RECEIVED_IN_CASH' %}
                                            <span class="badge bg-success">Recebida em Dinheiro</span>
                                        {% elif item.status == 'PENDING' %}
                                            <span class="badge bg-warning">Pendente</span>
                                        {% elif item.status == 'OVERDUE' %}
                                            <span class="badge bg-danger">Vencida</span>
                                        {% elif item.status == 'REFUNDED' %}
                                            <span class="badge bg-info">Estornada</span>
                                        {% elif item.status == 'REFUND_REQUESTED' %}
                                            <span class="badge bg-warning">Estorno Solicitado</span>
                                        {% elif item.status == 'CHARGEBACK_REQUESTED' %}
                                            <span class="badge bg-danger">Chargeback Solicitado</span>
                                        {% elif item.status == 'CHARGEBACK_DISPUTE' %}
                                            <span class="badge bg-warning">Contesta√ß√£o Chargeback</span>
                                        {% elif item.status == 'AWAITING_CHARGEBACK_REVERSAL' %}
                                            <span class="badge bg-info">Aguardando Revers√£o</span>
                                        {% elif item.status == 'DUNNING_REQUESTED' %}
                                            <span class="badge bg-warning">Negativa√ß√£o Solicitada</span>
                                        {% elif item.status == 'DUNNING_RECEIVED' %}
                                            <span class="badge bg-danger">Negativado</span>
                                        {% elif item.status == 'AWAITING_RISK_ANALYSIS' %}
                                            <span class="badge bg-info">Aguardando An√°lise</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ item.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">{{ item.total }}</td>
                                    <td class="text-end">R$ {{ item.valor_total|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Hist√≥rico de Sincroniza√ß√µes</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Status</th>
                                    <th class="text-end">Clientes</th>
                                    <th class="text-end">Cobran√ßas</th>
                                    <th class="text-end">Dura√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sync in ultimas_syncs %}
                                <tr>
                                    <td>{{ sync.data_inicio|date:"d/m/Y H:i" }}</td>
                                    <td>
                                        {% if sync.status == 'SUCESSO' %}
                                            <span class="badge bg-success">{{ sync.get_status_display }}</span>
                                        {% elif sync.status == 'PARCIAL' %}
                                            <span class="badge bg-warning">{{ sync.get_status_display }}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ sync.get_status_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">{{ sync.total_clientes }} ({{ sync.clientes_novos }} novos)</td>
                                    <td class="text-end">{{ sync.total_cobrancas }} ({{ sync.cobrancas_novas }} novas)</td>
                                    <td class="text-end">{{ sync.duracao_segundos }}s</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">Nenhuma sincroniza√ß√£o realizada</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
        <!-- Links R√°pidos -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-3"><i class="fas fa-link me-2"></i>Links R√°pidos</h5>
                            <div class="d-grid gap-2 d-md-flex">
                                <a href="{% url 'asaas_sync:lista_clientes' %}" class="btn btn-outline-primary">
                                    <i class="fas fa-users me-2"></i>Ver Todos os Clientes
                                </a>
                                <a href="{% url 'asaas_sync:lista_cobrancas' %}" class="btn btn-outline-success">
                                    <i class="fas fa-receipt me-2"></i>Ver Todas as Cobran√ßas
                                </a>                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <!-- Cobran√ßas Recentes -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Cobran√ßas Recentes</h5>
                    <a href="{% url 'asaas_sync:lista_cobrancas' %}" class="btn btn-sm btn-light">Ver Todas</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                    <th class="text-end">Valor</th>
                                    <th>Vencimento</th>
                                    <th>Pagou em</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cobranca in cobrancas_recentes %}
                                <tr>
                                    <td>
                                        <a href="{% url 'asaas_sync:detalhes_cliente' cobranca.cliente.id %}">
                                            {{ cobranca.cliente.nome }}
                                        </a>
                                    </td>
                                    <td><span class="badge bg-info">{{ cobranca.get_tipo_cobranca_display }}</span></td>
                                    <td>
                                        {% if cobranca.status == 'RECEIVED' or cobranca.status == 'CONFIRMED' %}
                                            <span class="badge bg-success">{{ cobranca.get_status_display }}</span>
                                        {% elif cobranca.status == 'PENDING' %}
                                            <span class="badge bg-warning">{{ cobranca.get_status_display }}</span>
                                        {% elif cobranca.status == 'OVERDUE' %}
                                            <span class="badge bg-danger">{{ cobranca.get_status_display }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ cobranca.get_status_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end fw-bold">R$ {{ cobranca.valor|floatformat:2 }}</td>
                                    <td>{{ cobranca.data_vencimento|date:"d/m/Y" }}</td>
                                    <td>{{ cobranca.data_pagamento|date:"d/m/Y"|default:"-" }}</td>
                                    <td>
                                        {% if cobranca.invoice_url %}
                                        <a href="{{ cobranca.invoice_url }}" target="_blank" class="btn btn-sm btn-outline-primary" title="Ver Fatura">
                                            <i class="fas fa-file-invoice"></i>
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted">Nenhuma cobran√ßa encontrada</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

   

<script>
function sincronizarAgora() {
    if (!confirm('Deseja iniciar a sincroniza√ß√£o com o Asaas agora? Isso pode levar alguns minutos.')) {
        return;
    }
    
    const btn = event.target.closest('button');
    const btnHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sincronizando...';
    
    fetch('{% url "asaas_sync:sincronizar_agora" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Sincroniza√ß√£o conclu√≠da com sucesso!\n\n' +
                  'Clientes: ' + data.log.total_clientes + ' (' + data.log.clientes_novos + ' novos)\n' +
                  'Cobran√ßas: ' + data.log.total_cobrancas + ' (' + data.log.cobrancas_novas + ' novas)\n' +
                  'Dura√ß√£o: ' + data.log.duracao + 's');
            location.reload();
        } else {
            alert('‚ùå Erro na sincroniza√ß√£o: ' + data.message);
        }
    })
    .catch(error => {
        alert('‚ùå Erro ao sincronizar: ' + error);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = btnHtml;
    });
}

function sincronizarAsaasAlternativo() {
    if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Deseja sincronizar dados do Asaas Alternativo?\n\nEsta opera√ß√£o importar√° dados de outra conta Asaas de PRODU√á√ÉO.\n\nContinuar?')) {
        return;
    }
    
    const btn = event.target.closest('button');
    const btnHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sincronizando...';
    
    // Token alternativo para sincroniza√ß√£o (AMBIENTE DE PRODU√á√ÉO)
    // URL: https://api.asaas.com/v3
    const tokenAlternativo = '$aact_prod_000MzkwODA2MWY2OGM3MWRlMDU2NWM3MzJlNzZmNGZhZGY6OjM5MzQxOTNmLTFjNTAtNDcwNS1hNDQyLTYzYmM0YjBmODU1MTo6JGFhY2hfYWU4YWUxMmEtOTU2Zi00OTJhLTkxYmEtNjE4ZTlhNGFhNjQ3';
    
    fetch('{% url "asaas_sync:sincronizar_alternativo" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            token: tokenAlternativo
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Sincroniza√ß√£o do Asaas Alternativo conclu√≠da com sucesso!\n\n' +
                  'Clientes: ' + data.log.total_clientes + ' (' + data.log.clientes_novos + ' novos)\n' +
                  'Cobran√ßas: ' + data.log.total_cobrancas + ' (' + data.log.cobrancas_novas + ' novas)\n' +
                  'Dura√ß√£o: ' + data.log.duracao + 's');
            location.reload();
        } else {
            alert('‚ùå Erro na sincroniza√ß√£o: ' + data.message);
        }
    })
    .catch(error => {
        alert('‚ùå Erro ao sincronizar: ' + error);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = btnHtml;
    });
}
</script>
{% endblock %}
