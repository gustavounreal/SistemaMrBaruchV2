{% extends 'base/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard Asaas - Sistema Mr. Baruch{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Alerta sobre Token Alternativo (Colaps√°vel) -->
    <div class="mb-3">
        <button class="btn btn-outline-warning btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#infoSincronizacao" aria-expanded="false" aria-controls="infoSincronizacao">
            <i class="fas fa-info-circle me-2"></i>Informa√ß√µes sobre Sincroniza√ß√£o Alternativa
            <i class="fas fa-chevron-down ms-2"></i>
        </button>
    </div>
    
    <div class="collapse" id="infoSincronizacao">
        <div class="alert alert-warning alert-dismissible" role="alert">
            <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Informa√ß√£o sobre Sincroniza√ß√£o Alternativa</h5>
            <p class="mb-2">
                <strong>Asaas 1 (Principal):</strong> Sincroniza com a conta Asaas principal<br>
                <strong>Asaas 2 (Alternativo):</strong> Sincroniza com uma conta Asaas secund√°ria
            </p>
            <hr>
            <p class="mb-0">
                <small>
                    ‚ö†Ô∏è <strong>IMPORTANTE:</strong> Se a sincroniza√ß√£o alternativa retornar erro, pode ser:
                    <br>‚Ä¢ Credenciais expiradas
                    <br>‚Ä¢ Credenciais inv√°lidas
                    <br>‚Ä¢ Sem permiss√µes adequadas
                    <br><br>
                    üí° <strong>Solu√ß√£o:</strong> Verifique as credenciais da conta Asaas alternativa
                </small>
            </p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <h2 class="mb-3 mb-md-0"><i class="fas fa-chart-line me-2"></i>Dashboard Asaas - Dados Sincronizados</h2>
                <div class="d-flex gap-2 flex-wrap justify-content-end">
                    <button class="btn btn-primary" onclick="sincronizarAgora()" title="Sincroniza TODOS os clientes e cobran√ßas do ASAAS Principal">
                        <i class="fas fa-sync me-2"></i>Sincronizar Completo (Asaas 1)
                    </button>
                    <button class="btn btn-secondary" onclick="sincronizarAsaasAlternativo()" title="Sincroniza TODOS os clientes e cobran√ßas do ASAAS Alternativo">
                        <i class="fas fa-download me-2"></i>Sincronizar Completo (Asaas 2)
                    </button>
                    <button class="btn btn-info" onclick="sincronizarBoletosFaltantes()" title="Sincroniza APENAS boletos faltantes dos clientes j√° cadastrados">
                        <i class="fas fa-file-invoice me-2"></i>Sincronizar Boletos Faltantes
                    </button>
                </div>
            </div>
            {% if ultima_sync %}
            <small class="text-muted">
                √öltima sincroniza√ß√£o: {{ ultima_sync.data_inicio|date:"d/m/Y H:i" }} 
                - Status: 
                {% if ultima_sync.status == 'SUCESSO' %}
                    <span class="badge bg-success">{{ ultima_sync.get_status_display }}</span>
                {% elif ultima_sync.status == 'PARCIAL' %}
                    <span class="badge bg-warning">{{ ultima_sync.get_status_display }}</span>
                {% else %}
                    <span class="badge bg-danger">{{ ultima_sync.get_status_display }}</span>
                {% endif %}
            </small>
            {% endif %}
        </div>
    </div>

    <!-- Card de Progresso da Sincroniza√ß√£o (Oculto por padr√£o) -->
    <div class="row mb-4" id="cardProgressoSync" style="display: none;">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-sync fa-spin me-2"></i>
                            <span id="tituloProgresso">Sincronizando Boletos Faltantes...</span>
                        </h5>
                        <button type="button" class="btn btn-sm btn-light" onclick="fecharProgresso()" id="btnFecharProgresso" disabled>
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="alert alert-info mb-3" id="statusSyncCard">
                                <i class="fas fa-info-circle me-2"></i>
                                <span id="mensagemSyncCard">Iniciando sincroniza√ß√£o...</span>
                            </div>
                            
                            <div class="mb-2">
                                <small class="text-muted">Progresso estimado:</small>
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                         role="progressbar" 
                                         id="barraProgresso"
                                         style="width: 0%">
                                        <span id="textoProgresso">Iniciando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div id="estatisticasSyncCard">
                                <h6 class="mb-3">Estat√≠sticas em Tempo Real:</h6>
                                
                                <div class="card bg-light mb-2">
                                    <div class="card-body py-2 px-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">Clientes:</small>
                                            <strong id="totalClientesCard">0</strong>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card bg-light mb-2">
                                    <div class="card-body py-2 px-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">Total Cobran√ßas:</small>
                                            <strong id="totalCobrancasCard">0</strong>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card bg-success text-white mb-2">
                                    <div class="card-body py-2 px-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small>Novas:</small>
                                            <strong id="cobrancasNovasCard">0</strong>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card bg-primary text-white mb-2">
                                    <div class="card-body py-2 px-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small>Atualizadas:</small>
                                            <strong id="cobrancasAtualizadasCard">0</strong>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3 text-center">
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>
                                        <span id="duracaoSyncCard">0s</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de Estat√≠sticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total de Clientes</h6>
                            <h3 class="mb-0">{{ total_clientes }}</h3>
                        </div>
                        <i class="fas fa-users fa-3x opacity-50"></i>
                    </div>
                    <a href="{% url 'asaas_sync:lista_clientes' %}" class="text-white d-block mt-2">
                        <small>Ver todos <i class="fas fa-arrow-right ms-1"></i></small>
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Recebido</h6>
                            <h3 class="mb-0">R$ {{ total_recebido|floatformat:2 }}</h3>
                        </div>
                        <i class="fas fa-check-circle fa-3x opacity-50"></i>
                    </div>
                    <small class="text-white-50 d-block mt-2">Cobran√ßas pagas</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Pendente</h6>
                            <h3 class="mb-0">R$ {{ total_pendente|floatformat:2 }}</h3>
                        </div>
                        <i class="fas fa-clock fa-3x opacity-50"></i>
                    </div>
                    <small class="text-white-50 d-block mt-2">Aguardando pagamento</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Vencido</h6>
                            <h3 class="mb-0">R$ {{ total_vencido|floatformat:2 }}</h3>
                        </div>
                        <i class="fas fa-exclamation-triangle fa-3x opacity-50"></i>
                    </div>
                    <small class="text-white-50 d-block mt-2">Cobran√ßas vencidas</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Cobran√ßas por Status -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Cobran√ßas por Status</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th class="text-end">Quantidade</th>
                                    <th class="text-end">Valor Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cobrancas_por_status %}
                                <tr>
                                    <td>
                                        {% if item.status == 'RECEIVED' or item.status == 'CONFIRMED' %}
                                            <span class="badge bg-success">
                                                {% if item.status == 'RECEIVED' %}Recebida{% else %}Confirmada{% endif %}
                                            </span>
                                        {% elif item.status == 'RECEIVED_IN_CASH' %}
                                            <span class="badge bg-success">Recebida em Dinheiro</span>
                                        {% elif item.status == 'PENDING' %}
                                            <span class="badge bg-warning">Pendente</span>
                                        {% elif item.status == 'OVERDUE' %}
                                            <span class="badge bg-danger">Vencida</span>
                                        {% elif item.status == 'REFUNDED' %}
                                            <span class="badge bg-info">Estornada</span>
                                        {% elif item.status == 'REFUND_REQUESTED' %}
                                            <span class="badge bg-warning">Estorno Solicitado</span>
                                        {% elif item.status == 'CHARGEBACK_REQUESTED' %}
                                            <span class="badge bg-danger">Chargeback Solicitado</span>
                                        {% elif item.status == 'CHARGEBACK_DISPUTE' %}
                                            <span class="badge bg-warning">Contesta√ß√£o Chargeback</span>
                                        {% elif item.status == 'AWAITING_CHARGEBACK_REVERSAL' %}
                                            <span class="badge bg-info">Aguardando Revers√£o</span>
                                        {% elif item.status == 'DUNNING_REQUESTED' %}
                                            <span class="badge bg-warning">Negativa√ß√£o Solicitada</span>
                                        {% elif item.status == 'DUNNING_RECEIVED' %}
                                            <span class="badge bg-danger">Negativado</span>
                                        {% elif item.status == 'AWAITING_RISK_ANALYSIS' %}
                                            <span class="badge bg-info">Aguardando An√°lise</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ item.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">{{ item.total }}</td>
                                    <td class="text-end">R$ {{ item.valor_total|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Hist√≥rico de Sincroniza√ß√µes</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                    <th class="text-end">Clientes</th>
                                    <th class="text-end">Cobran√ßas</th>
                                    <th class="text-end">Dura√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sync in ultimas_syncs %}
                                <tr>
                                    <td>
                                        <small>{{ sync.data_inicio|date:"d/m H:i" }}</small>
                                    </td>
                                    <td>
                                        {% if sync.tipo_sincronizacao == 'BOLETOS_FALTANTES' %}
                                            <span class="badge bg-info" title="Sincroniza√ß√£o de Boletos Faltantes">
                                                <i class="fas fa-file-invoice"></i> Boletos
                                            </span>
                                        {% elif sync.tipo_sincronizacao == 'ALTERNATIVO' %}
                                            <span class="badge bg-secondary" title="Sincroniza√ß√£o Alternativa">
                                                <i class="fas fa-download"></i> Alt
                                            </span>
                                        {% else %}
                                            <span class="badge bg-primary" title="Sincroniza√ß√£o Completa">
                                                <i class="fas fa-sync"></i> Completa
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if sync.status == 'SUCESSO' %}
                                            <span class="badge bg-success">‚úì</span>
                                        {% elif sync.status == 'EM_ANDAMENTO' %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-spinner fa-spin"></i>
                                            </span>
                                        {% elif sync.status == 'PARCIAL' %}
                                            <span class="badge bg-warning">‚ö†</span>
                                        {% else %}
                                            <span class="badge bg-danger">‚úó</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <small>
                                            {{ sync.total_clientes }}
                                            {% if sync.clientes_novos > 0 %}
                                                <span class="text-success">(+{{ sync.clientes_novos }})</span>
                                            {% endif %}
                                        </small>
                                    </td>
                                    <td class="text-end">
                                        <small>
                                            <strong>{{ sync.total_cobrancas }}</strong>
                                            {% if sync.cobrancas_novas > 0 %}
                                                <span class="text-success">(+{{ sync.cobrancas_novas }})</span>
                                            {% endif %}
                                        </small>
                                    </td>
                                    <td class="text-end">
                                        <small>{{ sync.duracao_segundos|default:"-" }}s</small>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">Nenhuma sincroniza√ß√£o realizada</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if ultimas_syncs|length > 0 %}
                    <div class="mt-2 text-end">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Mostrando √∫ltimas 5 sincroniza√ß√µes
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
        <!-- Links R√°pidos -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-3"><i class="fas fa-link me-2"></i>Links R√°pidos</h5>
                            <div class="d-grid gap-2 d-md-flex mb-3">
                                <a href="{% url 'asaas_sync:lista_clientes' %}" class="btn btn-outline-primary">
                                    <i class="fas fa-users me-2"></i>Ver Todos os Clientes
                                </a>
                                <a href="{% url 'asaas_sync:lista_cobrancas' %}" class="btn btn-outline-success">
                                    <i class="fas fa-receipt me-2"></i>Ver Todas as Cobran√ßas
                                </a>
                               <!-- <a href="{% url 'asaas_sync:validar_sincronizacao' %}" class="btn btn-outline-info">
                                    <i class="fas fa-check-double me-2"></i>Validar Sincroniza√ß√£o
                                </a>-->
                            </div>
                            
                            <hr>
                            
                            <h5 class="card-title mb-3"><i class="fas fa-file-excel me-2"></i>Exportar para Excel</h5>
                            
                            <!-- Banco de Dados Local -->
                            <div class="mb-4">
                                <h6 class="text-muted mb-2"><i class="fas fa-database me-2"></i>Banco de Dados Local</h6>
                                <div class="d-flex gap-2 flex-wrap">
                                    <a href="{% url 'asaas_sync:exportar_clientes_excel' %}?origem=local" class="btn btn-primary">
                                        <i class="fas fa-users me-2"></i>Exportar Clientes
                                    </a>
                                    <a href="{% url 'asaas_sync:exportar_cobrancas_excel' %}?origem=local" class="btn btn-success">
                                        <i class="fas fa-receipt me-2"></i>Exportar Cobran√ßas
                                    </a>
                                    <a href="{% url 'asaas_sync:exportar_clientes_com_boletos_excel' %}?origem=local" class="btn btn-info">
                                        <i class="fas fa-file-invoice-dollar me-2"></i>Exportar Completo (Clientes + Boletos)
                                    </a>
                                </div>
                            </div>
                            
                            <!-- ASAAS Principal 
                            <div class="mb-4">
                                <h6 class="text-muted mb-2"><i class="fas fa-cloud me-2"></i>ASAAS Principal</h6>
                                <div class="d-flex gap-2 flex-wrap mb-2">
                                    <a href="{% url 'asaas_sync:exportar_clientes_excel' %}?origem=asaas" class="btn btn-outline-primary">
                                        <i class="fas fa-users me-2"></i>Exportar Clientes
                                    </a>
                                    <a href="{% url 'asaas_sync:exportar_cobrancas_excel' %}?origem=asaas" class="btn btn-outline-success">
                                        <i class="fas fa-receipt me-2"></i>Exportar Cobran√ßas
                                    </a>
                                    <a href="{% url 'asaas_sync:exportar_clientes_com_boletos_excel' %}?origem=asaas" class="btn btn-outline-info">
                                        <i class="fas fa-file-invoice-dollar me-2"></i>Exportar Completo (Clientes + Boletos)
                                    </a>
                                </div>
                               <div class="alert alert-warning mb-0" role="alert">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Aten√ß√£o:</strong> O token principal est√° inv√°lido. Use o ASAAS Alternativo.
                                </div>
                            </div>-->
                            
                            <!-- ASAAS Alternativo 
                            <div class="mb-3">
                                <h6 class="text-muted mb-2"><i class="fas fa-cloud me-2"></i>ASAAS Alternativo</h6>
                                <div class="d-flex gap-2 flex-wrap mb-2">
                                    <a href="{% url 'asaas_sync:exportar_clientes_excel' %}?origem=asaas&alternativo=true" class="btn btn-warning">
                                        <i class="fas fa-users me-2"></i>Exportar Clientes
                                    </a>
                                    <a href="{% url 'asaas_sync:exportar_cobrancas_excel' %}?origem=asaas&alternativo=true" class="btn btn-warning">
                                        <i class="fas fa-receipt me-2"></i>Exportar Cobran√ßas
                                    </a>
                                    <a href="{% url 'asaas_sync:exportar_clientes_com_boletos_excel' %}?origem=asaas&alternativo=true" class="btn btn-warning">
                                        <i class="fas fa-file-invoice-dollar me-2"></i>Exportar Completo (Clientes + Boletos)
                                    </a>
                                </div>
                               <div class="alert alert-success mb-0" role="alert">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Token V√°lido:</strong> 1253 clientes dispon√≠veis.
                                </div>-->
                            </div>
                            
                            <div class="alert alert-info mt-3 mb-0" role="alert">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Sobre as Exporta√ß√µes:</strong><br>
                                <small>
                                    ‚Ä¢ <strong>Banco Local:</strong> Dados j√° sincronizados no sistema (r√°pido)<br>
                                    ‚Ä¢ <strong>ASAAS:</strong> Dados em tempo real da API (pode demorar alguns minutos)<br>
                                    ‚Ä¢ <strong>Completo:</strong> Relat√≥rio detalhado com cada cliente e seus boletos
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <!-- Cobran√ßas Recentes -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Cobran√ßas Recentes</h5>
                    <a href="{% url 'asaas_sync:lista_cobrancas' %}" class="btn btn-sm btn-light">Ver Todas</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                    <th class="text-end">Valor</th>
                                    <th>Vencimento</th>
                                    <th>Pagou em</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cobranca in cobrancas_recentes %}
                                <tr>
                                    <td>
                                        <a href="{% url 'asaas_sync:detalhes_cliente' cobranca.cliente.id %}">
                                            {{ cobranca.cliente.nome }}
                                        </a>
                                    </td>
                                    <td><span class="badge bg-info">{{ cobranca.get_tipo_cobranca_display }}</span></td>
                                    <td>
                                        {% if cobranca.status == 'RECEIVED' or cobranca.status == 'CONFIRMED' %}
                                            <span class="badge bg-success">{{ cobranca.get_status_display }}</span>
                                        {% elif cobranca.status == 'PENDING' %}
                                            <span class="badge bg-warning">{{ cobranca.get_status_display }}</span>
                                        {% elif cobranca.status == 'OVERDUE' %}
                                            <span class="badge bg-danger">{{ cobranca.get_status_display }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ cobranca.get_status_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end fw-bold">R$ {{ cobranca.valor|floatformat:2 }}</td>
                                    <td>{{ cobranca.data_vencimento|date:"d/m/Y" }}</td>
                                    <td>{{ cobranca.data_pagamento|date:"d/m/Y"|default:"-" }}</td>
                                    <td>
                                        {% if cobranca.invoice_url %}
                                        <a href="{{ cobranca.invoice_url }}" target="_blank" class="btn btn-sm btn-outline-primary" title="Ver Fatura">
                                            <i class="fas fa-file-invoice"></i>
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted">Nenhuma cobran√ßa encontrada</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
let intervalCheckStatus = null;
let tempoInicio = null;

function sincronizarAgora() {
    if (!confirm('Deseja iniciar a sincroniza√ß√£o com o Asaas agora? Isso pode levar alguns minutos.')) {
        return;
    }
    
    const btn = event.target.closest('button');
    const btnHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sincronizando...';
    
    fetch('{% url "asaas_sync:sincronizar_agora" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Sincroniza√ß√£o conclu√≠da com sucesso!\n\n' +
                  'Clientes: ' + data.log.total_clientes + ' (' + data.log.clientes_novos + ' novos)\n' +
                  'Cobran√ßas: ' + data.log.total_cobrancas + ' (' + data.log.cobrancas_novas + ' novas)\n' +
                  'Dura√ß√£o: ' + data.log.duracao + 's');
            location.reload();
        } else {
            alert('‚ùå Erro na sincroniza√ß√£o: ' + data.message);
        }
    })
    .catch(error => {
        alert('‚ùå Erro ao sincronizar: ' + error);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = btnHtml;
    });
}

function sincronizarAsaasAlternativo() {
    if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Deseja sincronizar dados do Asaas Alternativo?\n\nEsta opera√ß√£o importar√° dados de outra conta Asaas de PRODU√á√ÉO em background.\n\nO processo levar√° alguns minutos.\n\nContinuar?')) {
        return;
    }
    
    const btn = event.target.closest('button');
    const btnHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Iniciando...';
    
    // Token armazenado de forma segura no backend
    fetch('{% url "asaas_sync:sincronizar_alternativo" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Sincroniza√ß√£o iniciada em background
            alert(data.message);
            // Recarregar ap√≥s 3 segundos para mostrar que o processo iniciou
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            alert('‚ùå Erro: ' + data.message);
            btn.disabled = false;
            btn.innerHTML = btnHtml;
        }
    })
    .catch(error => {
        alert('‚ùå Erro ao sincronizar: ' + error);
        btn.disabled = false;
        btn.innerHTML = btnHtml;
    });
}

function sincronizarBoletosFaltantes() {
    if (!confirm('Esta opera√ß√£o vai sincronizar APENAS os boletos faltantes dos clientes j√° cadastrados.\n\nDeseja continuar?')) {
        return;
    }
    
    // Mostrar card de progresso
    document.getElementById('cardProgressoSync').style.display = 'block';
    document.getElementById('cardProgressoSync').scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    // Resetar estado
    document.getElementById('mensagemSyncCard').textContent = 'Iniciando sincroniza√ß√£o...';
    document.getElementById('statusSyncCard').className = 'alert alert-info mb-3';
    document.getElementById('btnFecharProgresso').disabled = true;
    document.getElementById('barraProgresso').style.width = '10%';
    document.getElementById('textoProgresso').textContent = 'Iniciando...';
    
    // Resetar contadores
    document.getElementById('totalClientesCard').textContent = '0';
    document.getElementById('totalCobrancasCard').textContent = '0';
    document.getElementById('cobrancasNovasCard').textContent = '0';
    document.getElementById('cobrancasAtualizadasCard').textContent = '0';
    document.getElementById('duracaoSyncCard').textContent = '0s';
    
    tempoInicio = Date.now();
    
    fetch('{% url "asaas_sync:sincronizar_boletos_faltantes" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('mensagemSyncCard').textContent = 'Sincroniza√ß√£o em andamento...';
            document.getElementById('barraProgresso').style.width = '30%';
            document.getElementById('textoProgresso').textContent = 'Processando...';
            
            // Iniciar verifica√ß√£o de status
            verificarStatusSincronizacao(data.log_id);
        } else {
            document.getElementById('statusSyncCard').className = 'alert alert-danger mb-3';
            document.getElementById('mensagemSyncCard').innerHTML = '<i class="fas fa-times-circle me-2"></i>' + data.message;
            document.getElementById('btnFecharProgresso').disabled = false;
            document.getElementById('barraProgresso').style.width = '0%';
            document.getElementById('barraProgresso').classList.remove('progress-bar-animated');
        }
    })
    .catch(error => {
        document.getElementById('statusSyncCard').className = 'alert alert-danger mb-3';
        document.getElementById('mensagemSyncCard').innerHTML = '<i class="fas fa-times-circle me-2"></i>Erro: ' + error;
        document.getElementById('btnFecharProgresso').disabled = false;
        document.getElementById('barraProgresso').style.width = '0%';
        document.getElementById('barraProgresso').classList.remove('progress-bar-animated');
    });
}

function verificarStatusSincronizacao(logId) {
    if (intervalCheckStatus) {
        clearInterval(intervalCheckStatus);
    }
    
    intervalCheckStatus = setInterval(() => {
        // Atualizar dura√ß√£o
        if (tempoInicio) {
            const segundos = Math.floor((Date.now() - tempoInicio) / 1000);
            document.getElementById('duracaoSyncCard').textContent = segundos + 's';
        }
        
        fetch(`/asaas-sync/status-sincronizacao/${logId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Atualizar estat√≠sticas
                    if (data.total_clientes > 0) {
                        document.getElementById('totalClientesCard').textContent = data.total_clientes || 0;
                        document.getElementById('totalCobrancasCard').textContent = data.total_cobrancas || 0;
                        document.getElementById('cobrancasNovasCard').textContent = data.cobrancas_novas || 0;
                        document.getElementById('cobrancasAtualizadasCard').textContent = data.cobrancas_atualizadas || 0;
                        
                        // Atualizar barra de progresso (estimativa)
                        const progresso = Math.min(90, 30 + (data.total_clientes * 0.05));
                        document.getElementById('barraProgresso').style.width = progresso + '%';
                        document.getElementById('textoProgresso').textContent = data.total_clientes + ' clientes processados';
                    }
                    
                    // Verificar se finalizou
                    if (data.status === 'SUCESSO') {
                        clearInterval(intervalCheckStatus);
                        document.getElementById('statusSyncCard').className = 'alert alert-success mb-3';
                        document.getElementById('mensagemSyncCard').innerHTML = 
                            '<i class="fas fa-check-circle me-2"></i>‚úÖ Sincroniza√ß√£o conclu√≠da com sucesso!';
                        document.getElementById('btnFecharProgresso').disabled = false;
                        document.getElementById('barraProgresso').style.width = '100%';
                        document.getElementById('barraProgresso').classList.remove('progress-bar-animated');
                        document.getElementById('barraProgresso').classList.remove('bg-info');
                        document.getElementById('barraProgresso').classList.add('bg-success');
                        document.getElementById('textoProgresso').textContent = '‚úì Conclu√≠do!';
                        
                        if (data.duracao_segundos) {
                            document.getElementById('duracaoSyncCard').textContent = data.duracao_segundos + 's';
                        }
                        
                    } else if (data.status === 'ERRO') {
                        clearInterval(intervalCheckStatus);
                        document.getElementById('statusSyncCard').className = 'alert alert-danger mb-3';
                        document.getElementById('mensagemSyncCard').innerHTML = 
                            '<i class="fas fa-times-circle me-2"></i>‚ùå Erro: ' + (data.erros || 'Erro desconhecido');
                        document.getElementById('btnFecharProgresso').disabled = false;
                        document.getElementById('barraProgresso').classList.remove('progress-bar-animated');
                        document.getElementById('barraProgresso').classList.remove('bg-info');
                        document.getElementById('barraProgresso').classList.add('bg-danger');
                        document.getElementById('textoProgresso').textContent = '‚úó Erro';
                        
                    } else if (data.status === 'EM_ANDAMENTO') {
                        document.getElementById('mensagemSyncCard').textContent = data.mensagem || 'Processando...';
                    }
                }
            })
            .catch(error => {
                console.error('Erro ao verificar status:', error);
            });
    }, 2000); // Verificar a cada 2 segundos
}

function fecharProgresso() {
    document.getElementById('cardProgressoSync').style.display = 'none';
    if (intervalCheckStatus) {
        clearInterval(intervalCheckStatus);
    }
    // Recarregar para mostrar novos dados
    location.reload();
}
</script>
{% endblock %}
